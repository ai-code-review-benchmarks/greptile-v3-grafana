---
{"kind": "pipeline", "type": "docker", "name": "pr-verify-drone", "trigger": {"event": ["pull_request"], "paths": {"exclude": ["docs/**", "*.md"], "include": ["scripts/drone/**", ".drone.yml", ".drone.star"]}}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "lint-drone", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["./bin/build verify-drone"], "depends_on": ["compile-build-cmd"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "pr-verify-starlark", "trigger": {"event": ["pull_request"], "paths": {"exclude": ["docs/**", "*.md"], "include": ["scripts/drone/**", ".drone.star"]}}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "lint-starlark", "image": "golang:1.23.0-alpine", "commands": ["go install github.com/bazelbuild/buildtools/buildifier@latest", "buildifier --lint=warn -mode=check -r ."], "depends_on": ["compile-build-cmd"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "pr-test-frontend", "trigger": {"event": ["pull_request"], "paths": {"exclude": ["docs/**", "*.md", "pkg/**", "packaging/**", "go.sum", "go.mod"], "include": []}}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "yarn-install", "image": "node:20.9.0-alpine", "commands": ["yarn install --immutable"], "depends_on": []}, {"name": "betterer-frontend", "image": "node:20.9.0-alpine", "depends_on": ["yarn-install"], "commands": ["apk add --update git bash", "yarn betterer ci"]}, {"name": "clone-enterprise", "image": "alpine/git:2.40.1", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apk add --update curl jq bash", "is_fork=$(curl \"https://$GITHUB_TOKEN@api.github.com/repos/grafana/grafana/pulls/$DRONE_PULL_REQUEST\" | jq .head.repo.fork)", "if [ \"$is_fork\" != false ]; then return 1; fi", "git clone \"https://$${GITHUB_TOKEN}@github.com/grafana/grafana-enterprise.git\" ../grafana-enterprise", "cd ../grafana-enterprise", "if git checkout ${DRONE_SOURCE_BRANCH}; then echo \"checked out ${DRONE_SOURCE_BRANCH}\"; elif git checkout ${DRONE_TARGET_BRANCH}; then echo \"git checkout ${DRONE_TARGET_BRANCH}\"; else git checkout main; fi", "cd ../", "ln -s src grafana", "cd ./grafana-enterprise", "./build.sh"], "failure": "ignore"}, {"name": "test-frontend", "image": "node:20.9.0-alpine", "environment": {"TEST_MAX_WORKERS": "50%"}, "depends_on": ["yarn-install"], "commands": ["yarn run ci:test-frontend"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "pr-lint-frontend", "trigger": {"event": ["pull_request"], "paths": {"exclude": ["docs/**", "*.md", "pkg/**", "packaging/**", "go.sum", "go.mod"], "include": []}}, "services": [], "steps": [{"name": "clone-enterprise", "image": "alpine/git:2.40.1", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apk add --update curl jq bash", "is_fork=$(curl \"https://$GITHUB_TOKEN@api.github.com/repos/grafana/grafana/pulls/$DRONE_PULL_REQUEST\" | jq .head.repo.fork)", "if [ \"$is_fork\" != false ]; then return 1; fi", "git clone \"https://$${GITHUB_TOKEN}@github.com/grafana/grafana-enterprise.git\" ../grafana-enterprise", "cd ../grafana-enterprise", "if git checkout ${DRONE_SOURCE_BRANCH}; then echo \"checked out ${DRONE_SOURCE_BRANCH}\"; elif git checkout ${DRONE_TARGET_BRANCH}; then echo \"git checkout ${DRONE_TARGET_BRANCH}\"; else git checkout main; fi", "cd ../", "ln -s src grafana", "cd ./grafana-enterprise", "./build.sh"], "failure": "ignore"}, {"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "yarn-install", "image": "node:20.9.0-alpine", "commands": ["yarn install --immutable"], "depends_on": []}, {"name": "lint-frontend", "image": "node:20.9.0-alpine", "environment": {"TEST_MAX_WORKERS": "50%"}, "depends_on": ["yarn-install"], "commands": ["yarn run prettier:check", "yarn run lint", "yarn run typecheck"]}, {"name": "verify-i18n", "image": "node:20.9.0-alpine", "depends_on": ["yarn-install"], "commands": ["apk add --update git", "yarn run i18n:extract || (echo \"\nExtraction failed. Make sure that you have no dynamic translation phrases, such as 't(\\`preferences.theme.\\$${themeID}\\`, themeName)' and that no translation key is used twice. Search the output for '[warning]' to find the offending file.\" \u0026\u0026 false)", "\n            file_diff=$(git diff --dirstat public/locales)\n            if [ -n \"$file_diff\" ]; then\n                echo $file_diff\n                echo \"\nTranslation extraction has not been committed. Please run 'yarn i18n:extract', commit the changes and push again.\"\n                exit 1\n            fi\n            ", "yarn run i18n:compile"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "pr-test-backend", "trigger": {"event": ["pull_request"], "paths": {"exclude": ["docs/**", "*.md"], "include": ["pkg/**", "packaging/**", ".drone.yml", "conf/**", "go.sum", "go.mod", "public/app/plugins/**/plugin.json", "docs/sources/setup-grafana/configure-grafana/feature-toggles/**", "devenv/**"]}}, "services": [], "steps": [{"name": "clone-enterprise", "image": "alpine/git:2.40.1", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apk add --update curl jq bash", "is_fork=$(curl \"https://$GITHUB_TOKEN@api.github.com/repos/grafana/grafana/pulls/$DRONE_PULL_REQUEST\" | jq .head.repo.fork)", "if [ \"$is_fork\" != false ]; then return 1; fi", "git clone \"https://$${GITHUB_TOKEN}@github.com/grafana/grafana-enterprise.git\" ../grafana-enterprise", "cd ../grafana-enterprise", "if git checkout ${DRONE_SOURCE_BRANCH}; then echo \"checked out ${DRONE_SOURCE_BRANCH}\"; elif git checkout ${DRONE_TARGET_BRANCH}; then echo \"git checkout ${DRONE_TARGET_BRANCH}\"; else git checkout main; fi", "cd ../", "ln -s src grafana", "cd ./grafana-enterprise", "./build.sh"], "failure": "ignore"}, {"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "verify-gen-cue", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that code generated from Thema/CUE be committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-cue"]}, {"name": "verify-gen-jsonnet", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that generated jsonnet is committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-jsonnet"]}, {"name": "wire-install", "image": "golang:1.23.0-alpine", "commands": ["apk add --update make", "make gen-go"], "depends_on": ["verify-gen-cue"]}, {"name": "test-backend", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install"], "commands": ["apk add --update build-base shared-mime-info shared-mime-info-lang", "go list -f '{{.Dir}}/...' -m | xargs go test -tags requires_buildifer -short -covermode=atomic -timeout=5m"]}, {"name": "test-backend-integration", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install"], "commands": ["apk add --update build-base", "go test -count=1 -covermode=atomic -timeout=5m -run '^TestIntegration' $(find ./pkg -type f -name '*_test.go' -exec grep -l '^func TestIntegration' '{}' '+' | grep -o '\\(.*\\)/' | sort -u)"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "pr-lint-backend", "trigger": {"event": ["pull_request"], "paths": {"exclude": ["docs/**", "*.md"], "include": ["pkg/**", "packaging/**", ".drone.yml", "conf/**", "go.sum", "go.mod", "public/app/plugins/**/plugin.json", "devenv/**", ".bingo/**"]}}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "clone-enterprise", "image": "alpine/git:2.40.1", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apk add --update curl jq bash", "is_fork=$(curl \"https://$GITHUB_TOKEN@api.github.com/repos/grafana/grafana/pulls/$DRONE_PULL_REQUEST\" | jq .head.repo.fork)", "if [ \"$is_fork\" != false ]; then return 1; fi", "git clone \"https://$${GITHUB_TOKEN}@github.com/grafana/grafana-enterprise.git\" ../grafana-enterprise", "cd ../grafana-enterprise", "if git checkout ${DRONE_SOURCE_BRANCH}; then echo \"checked out ${DRONE_SOURCE_BRANCH}\"; elif git checkout ${DRONE_TARGET_BRANCH}; then echo \"git checkout ${DRONE_TARGET_BRANCH}\"; else git checkout main; fi", "cd ../", "ln -s src grafana", "cd ./grafana-enterprise", "./build.sh"], "failure": "ignore"}, {"name": "wire-install", "image": "golang:1.23.0-alpine", "commands": ["apk add --update make", "make gen-go"], "depends_on": []}, {"name": "lint-backend", "image": "golang:1.23.0-alpine", "environment": {"CGO_ENABLED": "1"}, "depends_on": ["wire-install"], "commands": ["apk add --update make build-base", "make lint-go"]}, {"name": "validate-modfile", "image": "golang:1.23.0-alpine", "commands": ["go run scripts/modowners/modowners.go check go.mod"]}, {"name": "validate-openapi-spec", "image": "golang:1.23.0-alpine", "commands": ["apk add --update make", "make swagger-validate"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "pr-build-e2e", "trigger": {"event": ["pull_request"], "paths": {"exclude": ["*.md", "docs/**", "latest.json"]}}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v3.0.50/grabpl", "chmod +x bin/grabpl"]}, {"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "verify-gen-cue", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that code generated from Thema/CUE be committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-cue"]}, {"name": "verify-gen-jsonnet", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that generated jsonnet is committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-jsonnet"]}, {"name": "wire-install", "image": "golang:1.23.0-alpine", "commands": ["apk add --update make", "make gen-go"], "depends_on": ["verify-gen-cue"]}, {"name": "yarn-install", "image": "node:20.9.0-alpine", "commands": ["yarn install --immutable"], "depends_on": []}, {"name": "build-frontend-packages", "image": "node:20.9.0-alpine", "environment": {"NODE_OPTIONS": "--max_old_space_size=8192"}, "depends_on": ["yarn-install"], "commands": ["apk add --update jq bash", "yarn packages:build", "yarn packages:pack", "./scripts/validate-npm-packages.sh"]}, {"name": "trigger-enterprise-downstream", "image": "grafana/drone-downstream", "settings": {"server": "https://drone.grafana.net", "token": {"from_secret": "drone_token"}, "repositories": ["grafana/grafana-enterprise@${DRONE_SOURCE_BRANCH}"], "params": ["SOURCE_BUILD_NUMBER=${DRONE_COMMIT}", "SOURCE_COMMIT=${DRONE_COMMIT}", "OSS_PULL_REQUEST=${DRONE_PULL_REQUEST}"]}, "failure": "ignore"}, {"name": "rgm-package", "image": "grafana/grafana-build:main", "pull": "always", "depends_on": ["yarn-install"], "commands": ["/src/grafana-build artifacts -a targz:grafana:linux/amd64 -a targz:grafana:linux/arm64 -a targz:grafana:linux/arm/v7 --go-version=1.23.0 --yarn-cache=$$YARN_CACHE_FOLDER --build-id=$$DRONE_BUILD_NUMBER --grafana-dir=$$PWD > packages.txt"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}, {"name": "grafana-server", "image": "alpine:3.19.1", "detach": true, "depends_on": ["rgm-package"], "environment": {"GF_SERVER_HTTP_PORT": "3001", "GF_SERVER_ROUTER_LOGGING": "1", "GF_APP_MODE": "development"}, "commands": ["apk add --update tar bash", "mkdir grafana", "tar --strip-components=1 -xvf ./dist/*amd64.tar.gz -C grafana", "cp -r devenv scripts tools grafana && cd grafana && ./scripts/grafana-server/start-server"]}, {"name": "end-to-end-tests-dashboards-suite", "image": "cypress/included:13.1.0", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["./bin/build e2e-tests --port 3001 --suite dashboards-suite"]}, {"name": "end-to-end-tests-smoke-tests-suite", "image": "cypress/included:13.1.0", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["./bin/build e2e-tests --port 3001 --suite smoke-tests-suite"]}, {"name": "end-to-end-tests-panels-suite", "image": "cypress/included:13.1.0", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["./bin/build e2e-tests --port 3001 --suite panels-suite"]}, {"name": "end-to-end-tests-various-suite", "image": "cypress/included:13.1.0", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["./bin/build e2e-tests --port 3001 --suite various-suite"]}, {"name": "end-to-end-tests-cloud-plugins-suite-azure", "image": "us-docker.pkg.dev/grafanalabs-dev/cloud-data-sources/e2e-13.1.0:1.0.0", "depends_on": ["grafana-server"], "environment": {"CYPRESS_CI": "true", "HOST": "grafana-server", "GITHUB_TOKEN": {"from_secret": "github_token"}, "AZURE_SP_APP_ID": {"from_secret": "azure_sp_app_id"}, "AZURE_SP_PASSWORD": {"from_secret": "azure_sp_app_pw"}, "AZURE_TENANT": {"from_secret": "azure_tenant"}}, "commands": ["cd /", "./cpp-e2e/scripts/ci-run.sh azure ${DRONE_SOURCE_BRANCH}"], "when": {"repo": ["grafana/grafana"], "paths": {"include": ["pkg/tsdb/azuremonitor/**", "public/app/plugins/datasource/azuremonitor/**", "e2e/cloud-plugins-suite/azure-monitor.spec.ts"]}}}, {"name": "e2e-tests-artifacts-upload", "image": "google/cloud-sdk:431.0.0", "depends_on": ["end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "failure": "ignore", "when": {"status": ["success", "failure"]}, "environment": {"GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY": {"from_secret": "gcp_upload_artifacts_key"}, "E2E_TEST_ARTIFACTS_BUCKET": "releng-pipeline-artifacts-dev", "GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apt-get update", "apt-get install -yq zip", "printenv GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY > /tmp/gcpkey_upload_artifacts.json", "gcloud auth activate-service-account --key-file=/tmp/gcpkey_upload_artifacts.json", "find ./e2e -type f -name \"*spec.ts.mp4\" | zip e2e/videos.zip -@", "gsutil cp e2e/videos.zip gs://$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "export E2E_ARTIFACTS_VIDEO_ZIP=https://storage.googleapis.com/$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "echo \"E2E Test artifacts uploaded to: $${E2E_ARTIFACTS_VIDEO_ZIP}\"", "curl -X POST https://api.github.com/repos/${DRONE_REPO}/statuses/${DRONE_COMMIT_SHA} -H \"Authorization: token $${GITHUB_TOKEN}\" -d \"{\\\"state\\\":\\\"success\\\",\\\"target_url\\\":\\\"$${E2E_ARTIFACTS_VIDEO_ZIP}\\\", \\\"description\\\": \\\"Click on the details to download e2e recording videos\\\", \\\"context\\\": \\\"e2e_artifacts\\\"}\""]}, {"name": "build-storybook", "image": "node:20.9.0-alpine", "depends_on": ["rgm-package", "build-frontend-packages"], "environment": {"NODE_OPTIONS": "--max_old_space_size=4096"}, "commands": ["yarn storybook:build", "./bin/build verify-storybook"], "when": {"paths": {"include": ["packages/grafana-ui/**"]}}}, {"name": "test-a11y-frontend", "image": "grafana/docker-puppeteer:1.1.0", "depends_on": ["grafana-server"], "environment": {"GRAFANA_MISC_STATS_API_KEY": {"from_secret": "grafana_misc_stats_api_key"}, "HOST": "grafana-server", "PORT": 3001}, "failure": "always", "commands": ["npx wait-on@7.0.1 http://$HOST:$PORT", "pa11y-ci --config .pa11yci-pr.conf.js"]}, {"name": "rgm-build-docker", "image": "grafana/grafana-build:main", "pull": "always", "commands": ["docker run --privileged --rm tonistiigi/binfmt --install all", "/src/grafana-build artifacts -a docker:grafana:linux/amd64 -a docker:grafana:linux/amd64:ubuntu -a docker:grafana:linux/arm64 -a docker:grafana:linux/arm64:ubuntu -a docker:grafana:linux/arm/v7 -a docker:grafana:linux/arm/v7:ubuntu --yarn-cache=$$YARN_CACHE_FOLDER --build-id=$$DRONE_BUILD_NUMBER --go-version=1.23.0 --ubuntu-base=ubuntu:22.04 --alpine-base=alpine:3.19.1 --tag-format='{{ .version_base }}-{{ .buildID }}-{{ .arch }}' --grafana-dir=$$PWD --ubuntu-tag-format='{{ .version_base }}-{{ .buildID }}-ubuntu-{{ .arch }}' > docker.txt", "find ./dist -name '*docker*.tar.gz' -type f | xargs -n1 docker load -i"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "depends_on": ["yarn-install"]}, {"name": "publish-images-grafana", "image": "google/cloud-sdk:431.0.0", "environment": {"DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}, "GITHUB_APP_ID": {"from_secret": "delivery-bot-app-id"}, "GITHUB_APP_INSTALLATION_ID": {"from_secret": "delivery-bot-app-installation-id"}, "GITHUB_APP_PRIVATE_KEY": {"from_secret": "delivery-bot-app-private-key"}}, "commands": ["./bin/grabpl artifacts docker publish --dockerhub-repo grafana/grafana"], "depends_on": ["rgm-build-docker"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "failure": "ignore"}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "pr-integration-tests", "trigger": {"event": ["pull_request"], "paths": {"exclude": ["docs/**", "*.md"], "include": ["pkg/**", "packaging/**", ".drone.yml", "conf/**", "go.sum", "go.mod", "public/app/plugins/**/plugin.json"]}}, "services": [{"name": "postgres", "image": "postgres:12.3-alpine", "environment": {"POSTGRES_USER": "grafanatest", "POSTGRES_PASSWORD": "grafanatest", "POSTGRES_DB": "grafanatest", "PGDATA": "/var/lib/postgresql/data/pgdata"}, "volumes": [{"name": "postgres", "path": "/var/lib/postgresql/data/pgdata"}]}, {"name": "mysql57", "image": "mysql:5.7.39", "environment": {"MYSQL_ROOT_PASSWORD": "rootpass", "MYSQL_DATABASE": "grafana_tests", "MYSQL_USER": "grafana", "MYSQL_PASSWORD": "password"}, "volumes": [{"name": "mysql57", "path": "/var/lib/mysql"}], "commands": ["docker-entrypoint.sh mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci"]}, {"name": "mysql80", "image": "mysql:8.0.32", "environment": {"MYSQL_ROOT_PASSWORD": "rootpass", "MYSQL_DATABASE": "grafana_tests", "MYSQL_USER": "grafana", "MYSQL_PASSWORD": "password"}, "volumes": [{"name": "mysql80", "path": "/var/lib/mysql"}], "commands": ["docker-entrypoint.sh mysqld --default-authentication-plugin=mysql_native_password"]}, {"name": "mimir_backend", "image": "us.gcr.io/kubernetes-dev/mimir:gotjosh-state-config-grafana-663a0ae78", "environment": {}, "commands": ["/bin/mimir -target=backend"]}, {"name": "redis", "image": "redis:6.2.11-alpine", "environment": {}}, {"name": "memcached", "image": "memcached:1.6.9-alpine", "environment": {}}], "steps": [{"name": "clone-enterprise", "image": "alpine/git:2.40.1", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apk add --update curl jq bash", "is_fork=$(curl \"https://$GITHUB_TOKEN@api.github.com/repos/grafana/grafana/pulls/$DRONE_PULL_REQUEST\" | jq .head.repo.fork)", "if [ \"$is_fork\" != false ]; then return 1; fi", "git clone \"https://$${GITHUB_TOKEN}@github.com/grafana/grafana-enterprise.git\" ../grafana-enterprise", "cd ../grafana-enterprise", "if git checkout ${DRONE_SOURCE_BRANCH}; then echo \"checked out ${DRONE_SOURCE_BRANCH}\"; elif git checkout ${DRONE_TARGET_BRANCH}; then echo \"git checkout ${DRONE_TARGET_BRANCH}\"; else git checkout main; fi", "cd ../", "ln -s src grafana", "cd ./grafana-enterprise", "./build.sh"], "failure": "ignore"}, {"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v3.0.50/grabpl", "chmod +x bin/grabpl"]}, {"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "verify-gen-cue", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that code generated from Thema/CUE be committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-cue"]}, {"name": "verify-gen-jsonnet", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that generated jsonnet is committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-jsonnet"]}, {"name": "wire-install", "image": "golang:1.23.0-alpine", "commands": ["apk add --update make", "make gen-go"], "depends_on": ["verify-gen-cue"]}, {"name": "wait-for-postgres", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://postgres:5432 -timeout 120s"]}, {"name": "postgres-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-postgres"], "commands": ["apk add --update build-base", "apk add --update postgresql-client", "psql -p 5432 -h postgres -U grafanatest -d grafanatest -f devenv/docker/blocks/postgres_tests/setup.sql", "go clean -testcache", "go test -p=1 -count=1 -covermode=atomic -timeout=5m -run '^TestIntegration' $(find ./pkg -type f -name '*_test.go' -exec grep -l '^func TestIntegration' '{}' '+' | grep -o '\\(.*\\)/' | sort -u)"], "environment": {"PGPASSWORD": "grafanatest", "GRAFANA_TEST_DB": "postgres", "POSTGRES_HOST": "postgres"}}, {"name": "wait-for-mysql-5.7", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://mysql57:3306 -timeout 120s"]}, {"name": "mysql-5.7-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-mysql-5.7"], "commands": ["apk add --update build-base", "apk add --update mysql-client", "cat devenv/docker/blocks/mysql_tests/setup.sql | mysql -h mysql57 -P 3306 -u root -prootpass", "go clean -testcache", "go test -p=1 -count=1 -covermode=atomic -timeout=5m -run '^TestIntegration' $(find ./pkg -type f -name '*_test.go' -exec grep -l '^func TestIntegration' '{}' '+' | grep -o '\\(.*\\)/' | sort -u)"], "environment": {"GRAFANA_TEST_DB": "mysql", "MYSQL_HOST": "mysql57"}}, {"name": "wait-for-mysql-8.0", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://mysql80:3306 -timeout 120s"]}, {"name": "mysql-8.0-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-mysql-8.0"], "commands": ["apk add --update build-base", "apk add --update mysql-client", "cat devenv/docker/blocks/mysql_tests/setup.sql | mysql -h mysql80 -P 3306 -u root -prootpass", "go clean -testcache", "go test -p=1 -count=1 -covermode=atomic -timeout=5m -run '^TestIntegration' $(find ./pkg -type f -name '*_test.go' -exec grep -l '^func TestIntegration' '{}' '+' | grep -o '\\(.*\\)/' | sort -u)"], "environment": {"GRAFANA_TEST_DB": "mysql", "MYSQL_HOST": "mysql80"}}, {"name": "wait-for-redis", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://redis:6379 -timeout 120s"]}, {"name": "redis-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-redis"], "commands": ["apk add --update build-base", "go clean -testcache", "go list -f '{{.Dir}}/...' -m | xargs go test -run IntegrationRedis -covermode=atomic -timeout=2m"], "environment": {"REDIS_URL": "redis://redis:6379/0"}}, {"name": "wait-for-memcached", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://memcached:11211 -timeout 120s"]}, {"name": "memcached-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-memcached"], "commands": ["apk add --update build-base", "go clean -testcache", "go list -f '{{.Dir}}/...' -m | xargs go test -run IntegrationMemcached -covermode=atomic -timeout=2m"], "environment": {"MEMCACHED_HOSTS": "memcached:11211"}}, {"name": "wait-for-remote-alertmanager", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://mimir_backend:8080 -timeout 120s"]}, {"name": "remote-alertmanager-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-remote-alertmanager"], "commands": ["apk add --update build-base", "go clean -testcache", "go test -run TestIntegrationRemoteAlertmanager -covermode=atomic -timeout=2m ./pkg/services/ngalert/..."], "environment": {"AM_TENANT_ID": "test", "AM_URL": "http://mimir_backend:8080"}}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql57", "temp": {"medium": "memory"}}, {"name": "mysql80", "temp": {"medium": "memory"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "pr-docs", "trigger": {"event": ["pull_request"], "repo": ["grafana/grafana"], "paths": {"include": ["*.md", "docs/**", "packages/**/*.md", "latest.json"]}}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "yarn-install", "image": "node:20.9.0-alpine", "commands": ["yarn install --immutable"], "depends_on": []}, {"name": "codespell", "image": "python:3.8", "commands": ["pip3 install codespell", "codespell -I .codespellignore docs/"]}, {"name": "lint-docs", "image": "node:20.9.0-alpine", "depends_on": ["yarn-install"], "environment": {"NODE_OPTIONS": "--max_old_space_size=8192"}, "commands": ["yarn run prettier:checkDocs"]}, {"name": "build-docs-website", "image": "grafana/docs-base:latest", "pull": "always", "commands": ["mkdir -p /hugo/content/docs/grafana/latest", "echo -e '---\\nredirectURL: /docs/grafana/latest/\\ntype: redirect\\nversioned: true\\n---\\n' > /hugo/content/docs/grafana/_index.md", "cp -r docs/sources/* /hugo/content/docs/grafana/latest/", "cd /hugo && make prod"]}, {"name": "verify-gen-cue", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that code generated from Thema/CUE be committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-cue"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "pr-shellcheck", "trigger": {"event": ["pull_request"], "paths": {"exclude": ["*.md", "docs/**", "latest.json"], "include": ["scripts/**/*.sh"]}}, "services": [], "steps": [{"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "shellcheck", "image": "ubuntu:22.04", "commands": ["apt-get update -yq && apt-get install shellcheck", "shellcheck -e SC1071 -e SC2162 scripts/**/*.sh"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "pr-swagger-gen", "trigger": {"event": ["pull_request"], "paths": {"exclude": ["docs/**", "*.md"], "include": ["pkg/**"]}}, "services": [], "steps": [{"name": "clone-enterprise", "image": "alpine/git:2.40.1", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apk add --update curl jq bash", "is_fork=$(curl \"https://$GITHUB_TOKEN@api.github.com/repos/grafana/grafana/pulls/$DRONE_PULL_REQUEST\" | jq .head.repo.fork)", "if [ \"$is_fork\" != false ]; then return 1; fi", "git clone \"https://$${GITHUB_TOKEN}@github.com/grafana/grafana-enterprise.git\" grafana-enterprise", "cd grafana-enterprise", "if git checkout ${DRONE_SOURCE_BRANCH}; then echo \"checked out ${DRONE_SOURCE_BRANCH}\"; elif git checkout main; then echo \"git checkout main\"; else git checkout main; fi"], "failure": "ignore"}, {"name": "swagger-gen", "image": "golang:1.23.0-alpine", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apk add --update git make", "make swagger-clean && make openapi3-gen", "for f in public/api-merged.json public/openapi3.json; do git add $f; done", "if [ -z \"$(git diff --name-only --cached)\" ]; then echo \"Everything seems up to date!\"; else echo \"Please ensure the branch is up-to-date, then regenerate the specification by running make swagger-clean && make openapi3-gen\" && return 1; fi"], "depends_on": ["clone-enterprise"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "pr-integration-benchmarks", "trigger": {"event": ["promote"], "target": ["gobenchmarks"]}, "services": [{"name": "postgres", "image": "postgres:12.3-alpine", "environment": {"POSTGRES_USER": "grafanatest", "POSTGRES_PASSWORD": "grafanatest", "POSTGRES_DB": "grafanatest", "PGDATA": "/var/lib/postgresql/data/pgdata"}, "volumes": [{"name": "postgres", "path": "/var/lib/postgresql/data/pgdata"}]}, {"name": "mysql57", "image": "mysql:5.7.39", "environment": {"MYSQL_ROOT_PASSWORD": "rootpass", "MYSQL_DATABASE": "grafana_tests", "MYSQL_USER": "grafana", "MYSQL_PASSWORD": "password"}, "volumes": [{"name": "mysql57", "path": "/var/lib/mysql"}], "commands": ["docker-entrypoint.sh mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci"]}, {"name": "mysql80", "image": "mysql:8.0.32", "environment": {"MYSQL_ROOT_PASSWORD": "rootpass", "MYSQL_DATABASE": "grafana_tests", "MYSQL_USER": "grafana", "MYSQL_PASSWORD": "password"}, "volumes": [{"name": "mysql80", "path": "/var/lib/mysql"}], "commands": ["docker-entrypoint.sh mysqld --default-authentication-plugin=mysql_native_password"]}, {"name": "mimir_backend", "image": "us.gcr.io/kubernetes-dev/mimir:gotjosh-state-config-grafana-663a0ae78", "environment": {}, "commands": ["/bin/mimir -target=backend"]}, {"name": "redis", "image": "redis:6.2.11-alpine", "environment": {}}, {"name": "memcached", "image": "memcached:1.6.9-alpine", "environment": {}}], "steps": [{"name": "clone-enterprise", "image": "alpine/git:2.40.1", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apk add --update curl jq bash", "git clone \"https://$${GITHUB_TOKEN}@github.com/grafana/grafana-enterprise.git\" ../grafana-enterprise", "cd ../grafana-enterprise", "if git checkout ${DRONE_SOURCE_BRANCH}; then echo \"checked out ${DRONE_SOURCE_BRANCH}\"; elif git checkout ${DRONE_TARGET_BRANCH}; then echo \"git checkout ${DRONE_TARGET_BRANCH}\"; else git checkout main; fi", "cd ../", "ln -s src grafana", "cd ./grafana-enterprise", "./build.sh"], "failure": "ignore"}, {"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "verify-gen-cue", "image": "golang:1.23.0-alpine", "depends_on": ["clone-enterprise"], "commands": ["# It is required that code generated from Thema/CUE be committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-cue"]}, {"name": "verify-gen-jsonnet", "image": "golang:1.23.0-alpine", "depends_on": ["clone-enterprise"], "commands": ["# It is required that generated jsonnet is committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-jsonnet"]}, {"name": "wire-install", "image": "golang:1.23.0-alpine", "commands": ["apk add --update make", "make gen-go"], "depends_on": ["verify-gen-cue"]}, {"name": "sqlite-benchmark-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install"], "commands": ["apk add --update build-base", "if [ -z ${GO_PACKAGES} ]; then echo 'missing GO_PACKAGES'; false; fi", "go test -v -run=^$ -benchmem -timeout=1h -count=8 -bench=. ${GO_PACKAGES}"]}, {"name": "postgres-benchmark-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install"], "commands": ["apk add --update build-base", "if [ -z ${GO_PACKAGES} ]; then echo 'missing GO_PACKAGES'; false; fi", "go test -v -run=^$ -benchmem -timeout=1h -count=8 -bench=. ${GO_PACKAGES}"], "environment": {"PGPASSWORD": "grafanatest", "GRAFANA_TEST_DB": "postgres", "POSTGRES_HOST": "postgres"}}, {"name": "mysql-5.7-benchmark-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install"], "commands": ["apk add --update build-base", "if [ -z ${GO_PACKAGES} ]; then echo 'missing GO_PACKAGES'; false; fi", "go test -v -run=^$ -benchmem -timeout=1h -count=8 -bench=. ${GO_PACKAGES}"], "environment": {"GRAFANA_TEST_DB": "mysql", "MYSQL_HOST": "mysql57"}}, {"name": "mysql-8.0-benchmark-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install"], "commands": ["apk add --update build-base", "if [ -z ${GO_PACKAGES} ]; then echo 'missing GO_PACKAGES'; false; fi", "go test -v -run=^$ -benchmem -timeout=1h -count=8 -bench=. ${GO_PACKAGES}"], "environment": {"GRAFANA_TEST_DB": "mysql", "MYSQL_HOST": "mysql80"}}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql57", "temp": {"medium": "memory"}}, {"name": "mysql80", "temp": {"medium": "memory"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "main-docs", "trigger": {"branch": "main", "event": ["push"], "repo": ["grafana/grafana"], "paths": {"include": ["*.md", "docs/**", "packages/**/*.md", "latest.json"]}}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "yarn-install", "image": "node:20.9.0-alpine", "commands": ["yarn install --immutable"], "depends_on": []}, {"name": "codespell", "image": "python:3.8", "commands": ["pip3 install codespell", "codespell -I .codespellignore docs/"]}, {"name": "lint-docs", "image": "node:20.9.0-alpine", "depends_on": ["yarn-install"], "environment": {"NODE_OPTIONS": "--max_old_space_size=8192"}, "commands": ["yarn run prettier:checkDocs"]}, {"name": "build-docs-website", "image": "grafana/docs-base:latest", "pull": "always", "commands": ["mkdir -p /hugo/content/docs/grafana/latest", "echo -e '---\\nredirectURL: /docs/grafana/latest/\\ntype: redirect\\nversioned: true\\n---\\n' > /hugo/content/docs/grafana/_index.md", "cp -r docs/sources/* /hugo/content/docs/grafana/latest/", "cd /hugo && make prod"]}, {"name": "verify-gen-cue", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that code generated from Thema/CUE be committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-cue"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "main-test-frontend", "trigger": {"event": ["push"], "branch": "main", "paths": {"exclude": ["*.md", "docs/**", "latest.json"]}, "repo": ["grafana/grafana"]}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "yarn-install", "image": "node:20.9.0-alpine", "commands": ["yarn install --immutable"], "depends_on": []}, {"name": "betterer-frontend", "image": "node:20.9.0-alpine", "depends_on": ["yarn-install"], "commands": ["apk add --update git bash", "yarn betterer ci"]}, {"name": "test-frontend", "image": "node:20.9.0-alpine", "environment": {"TEST_MAX_WORKERS": "50%"}, "depends_on": ["yarn-install"], "commands": ["yarn run ci:test-frontend"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "main-lint-frontend", "trigger": {"event": ["push"], "branch": "main", "paths": {"exclude": ["*.md", "docs/**", "latest.json"]}, "repo": ["grafana/grafana"]}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "yarn-install", "image": "node:20.9.0-alpine", "commands": ["yarn install --immutable"], "depends_on": []}, {"name": "lint-frontend", "image": "node:20.9.0-alpine", "environment": {"TEST_MAX_WORKERS": "50%"}, "depends_on": ["yarn-install"], "commands": ["yarn run prettier:check", "yarn run lint", "yarn run typecheck"]}, {"name": "verify-i18n", "image": "node:20.9.0-alpine", "depends_on": ["yarn-install"], "commands": ["apk add --update git", "yarn run i18n:extract || (echo \"\nExtraction failed. Make sure that you have no dynamic translation phrases, such as 't(\\`preferences.theme.\\$${themeID}\\`, themeName)' and that no translation key is used twice. Search the output for '[warning]' to find the offending file.\" \u0026\u0026 false)", "\n            file_diff=$(git diff --dirstat public/locales)\n            if [ -n \"$file_diff\" ]; then\n                echo $file_diff\n                echo \"\nTranslation extraction has not been committed. Please run 'yarn i18n:extract', commit the changes and push again.\"\n                exit 1\n            fi\n            ", "yarn run i18n:compile"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "main-test-backend", "trigger": {"event": ["push"], "branch": "main", "paths": {"exclude": ["*.md", "docs/**", "latest.json"]}, "repo": ["grafana/grafana"]}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "verify-gen-cue", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that code generated from Thema/CUE be committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-cue"]}, {"name": "verify-gen-jsonnet", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that generated jsonnet is committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-jsonnet"]}, {"name": "wire-install", "image": "golang:1.23.0-alpine", "commands": ["apk add --update make", "make gen-go"], "depends_on": ["verify-gen-cue"]}, {"name": "test-backend", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install"], "commands": ["apk add --update build-base shared-mime-info shared-mime-info-lang", "go list -f '{{.Dir}}/...' -m | xargs go test -tags requires_buildifer -short -covermode=atomic -timeout=5m"]}, {"name": "test-backend-integration", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install"], "commands": ["apk add --update build-base", "go test -count=1 -covermode=atomic -timeout=5m -run '^TestIntegration' $(find ./pkg -type f -name '*_test.go' -exec grep -l '^func TestIntegration' '{}' '+' | grep -o '\\(.*\\)/' | sort -u)"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "main-lint-backend", "trigger": {"event": ["push"], "branch": "main", "paths": {"exclude": ["*.md", "docs/**", "latest.json"]}, "repo": ["grafana/grafana"]}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "wire-install", "image": "golang:1.23.0-alpine", "commands": ["apk add --update make", "make gen-go"], "depends_on": []}, {"name": "lint-backend", "image": "golang:1.23.0-alpine", "environment": {"CGO_ENABLED": "1"}, "depends_on": ["wire-install"], "commands": ["apk add --update make build-base", "make lint-go"]}, {"name": "validate-modfile", "image": "golang:1.23.0-alpine", "commands": ["go run scripts/modowners/modowners.go check go.mod"]}, {"name": "validate-openapi-spec", "image": "golang:1.23.0-alpine", "commands": ["apk add --update make", "make swagger-validate"]}, {"name": "lint-drone", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["./bin/build verify-drone"], "depends_on": ["compile-build-cmd"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "main-build-e2e-publish", "trigger": {"event": ["push"], "branch": "main", "paths": {"exclude": ["*.md", "docs/**", "latest.json"]}, "repo": ["grafana/grafana"]}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v3.0.50/grabpl", "chmod +x bin/grabpl"]}, {"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "verify-gen-cue", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that code generated from Thema/CUE be committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-cue"]}, {"name": "verify-gen-jsonnet", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that generated jsonnet is committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-jsonnet"]}, {"name": "wire-install", "image": "golang:1.23.0-alpine", "commands": ["apk add --update make", "make gen-go"], "depends_on": ["verify-gen-cue"]}, {"name": "yarn-install", "image": "node:20.9.0-alpine", "commands": ["yarn install --immutable"], "depends_on": []}, {"name": "update-package-json-version", "image": "node:20.9.0-alpine", "depends_on": ["yarn-install"], "commands": ["apk add --update jq", "new_version=$(cat package.json | jq .version | sed s/pre/${DRONE_BUILD_NUMBER}/g)", "echo \"New version: $new_version\"", "yarn run lerna version $new_version --exact --no-git-tag-version --no-push --force-publish -y", "yarn install --mode=update-lockfile"]}, {"name": "build-frontend-packages", "image": "node:20.9.0-alpine", "environment": {"NODE_OPTIONS": "--max_old_space_size=8192"}, "depends_on": ["yarn-install", "update-package-json-version"], "commands": ["apk add --update jq bash", "yarn packages:build", "yarn packages:pack", "./scripts/validate-npm-packages.sh"]}, {"name": "rgm-package", "image": "grafana/grafana-build:main", "pull": "always", "depends_on": ["update-package-json-version"], "commands": ["/src/grafana-build artifacts -a targz:grafana:linux/amd64 -a targz:grafana:linux/arm64 -a targz:grafana:linux/arm/v7 --go-version=1.23.0 --yarn-cache=$$YARN_CACHE_FOLDER --build-id=$$DRONE_BUILD_NUMBER --grafana-dir=$$PWD > packages.txt"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}, {"name": "grafana-server", "image": "alpine:3.19.1", "detach": true, "depends_on": ["rgm-package"], "environment": {"GF_SERVER_HTTP_PORT": "3001", "GF_SERVER_ROUTER_LOGGING": "1", "GF_APP_MODE": "development"}, "commands": ["apk add --update tar bash", "mkdir grafana", "tar --strip-components=1 -xvf ./dist/*amd64.tar.gz -C grafana", "cp -r devenv scripts tools grafana && cd grafana && ./scripts/grafana-server/start-server"]}, {"name": "end-to-end-tests-dashboards-suite", "image": "cypress/included:13.1.0", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["./bin/build e2e-tests --port 3001 --suite dashboards-suite"]}, {"name": "end-to-end-tests-smoke-tests-suite", "image": "cypress/included:13.1.0", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["./bin/build e2e-tests --port 3001 --suite smoke-tests-suite"]}, {"name": "end-to-end-tests-panels-suite", "image": "cypress/included:13.1.0", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["./bin/build e2e-tests --port 3001 --suite panels-suite"]}, {"name": "end-to-end-tests-various-suite", "image": "cypress/included:13.1.0", "depends_on": ["grafana-server"], "environment": {"HOST": "grafana-server"}, "commands": ["./bin/build e2e-tests --port 3001 --suite various-suite"]}, {"name": "end-to-end-tests-cloud-plugins-suite-azure", "image": "us-docker.pkg.dev/grafanalabs-dev/cloud-data-sources/e2e-13.1.0:1.0.0", "depends_on": ["grafana-server"], "environment": {"CYPRESS_CI": "true", "HOST": "grafana-server", "GITHUB_TOKEN": {"from_secret": "github_token"}, "AZURE_SP_APP_ID": {"from_secret": "azure_sp_app_id"}, "AZURE_SP_PASSWORD": {"from_secret": "azure_sp_app_pw"}, "AZURE_TENANT": {"from_secret": "azure_tenant"}}, "commands": ["cd /", "./cpp-e2e/scripts/ci-run.sh azure ${DRONE_SOURCE_BRANCH}"], "when": {"repo": ["grafana/grafana"], "paths": {"include": ["pkg/tsdb/azuremonitor/**", "public/app/plugins/datasource/azuremonitor/**", "e2e/cloud-plugins-suite/azure-monitor.spec.ts"]}}}, {"name": "e2e-tests-artifacts-upload", "image": "google/cloud-sdk:431.0.0", "depends_on": ["end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "failure": "ignore", "when": {"status": ["success", "failure"]}, "environment": {"GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY": {"from_secret": "gcp_upload_artifacts_key"}, "E2E_TEST_ARTIFACTS_BUCKET": "releng-pipeline-artifacts-dev", "GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["apt-get update", "apt-get install -yq zip", "printenv GCP_GRAFANA_UPLOAD_ARTIFACTS_KEY > /tmp/gcpkey_upload_artifacts.json", "gcloud auth activate-service-account --key-file=/tmp/gcpkey_upload_artifacts.json", "find ./e2e -type f -name \"*spec.ts.mp4\" | zip e2e/videos.zip -@", "gsutil cp e2e/videos.zip gs://$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "export E2E_ARTIFACTS_VIDEO_ZIP=https://storage.googleapis.com/$${E2E_TEST_ARTIFACTS_BUCKET}/${DRONE_BUILD_NUMBER}/artifacts/videos/videos.zip", "echo \"E2E Test artifacts uploaded to: $${E2E_ARTIFACTS_VIDEO_ZIP}\"", "curl -X POST https://api.github.com/repos/${DRONE_REPO}/statuses/${DRONE_COMMIT_SHA} -H \"Authorization: token $${GITHUB_TOKEN}\" -d \"{\\\"state\\\":\\\"success\\\",\\\"target_url\\\":\\\"$${E2E_ARTIFACTS_VIDEO_ZIP}\\\", \\\"description\\\": \\\"Click on the details to download e2e recording videos\\\", \\\"context\\\": \\\"e2e_artifacts\\\"}\""]}, {"name": "build-storybook", "image": "node:20.9.0-alpine", "depends_on": ["rgm-package", "build-frontend-packages"], "environment": {"NODE_OPTIONS": "--max_old_space_size=4096"}, "commands": ["yarn storybook:build", "./bin/build verify-storybook"], "when": {"paths": {"include": ["packages/grafana-ui/**"]}}}, {"name": "test-a11y-frontend", "image": "grafana/docker-puppeteer:1.1.0", "depends_on": ["grafana-server"], "environment": {"GRAFANA_MISC_STATS_API_KEY": {"from_secret": "grafana_misc_stats_api_key"}, "HOST": "grafana-server", "PORT": 3001}, "failure": "ignore", "commands": ["npx wait-on@7.0.1 http://$HOST:$PORT", "pa11y-ci --config .pa11yci.conf.js --json > pa11y-ci-results.json"]}, {"name": "store-storybook", "image": "grafana/grafana-ci-deploy:1.3.3", "depends_on": ["build-storybook", "end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "environment": {"GCP_KEY": {"from_secret": "gcp_grafanauploads"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/build store-storybook --deployment canary"], "when": {"repo": ["grafana/grafana"], "paths": {"include": ["packages/grafana-ui/**"]}}}, {"name": "publish-frontend-metrics", "image": "node:20.9.0-alpine", "depends_on": ["test-a11y-frontend"], "environment": {"GRAFANA_MISC_STATS_API_KEY": {"from_secret": "grafana_misc_stats_api_key"}}, "failure": "ignore", "commands": ["apk add --update bash grep git", "./scripts/ci-frontend-metrics.sh ./grafana/public/build | ./bin/build publish-metrics $$GRAFANA_MISC_STATS_API_KEY"], "when": {"repo": ["grafana/grafana"]}}, {"name": "rgm-build-docker", "image": "grafana/grafana-build:main", "pull": "always", "commands": ["docker run --privileged --rm tonistiigi/binfmt --install all", "/src/grafana-build artifacts -a docker:grafana:linux/amd64 -a docker:grafana:linux/amd64:ubuntu -a docker:grafana:linux/arm64 -a docker:grafana:linux/arm64:ubuntu -a docker:grafana:linux/arm/v7 -a docker:grafana:linux/arm/v7:ubuntu --yarn-cache=$$YARN_CACHE_FOLDER --build-id=$$DRONE_BUILD_NUMBER --go-version=1.23.0 --ubuntu-base=ubuntu:22.04 --alpine-base=alpine:3.19.1 --tag-format='{{ .version_base }}-{{ .buildID }}-{{ .arch }}' --grafana-dir=$$PWD --ubuntu-tag-format='{{ .version_base }}-{{ .buildID }}-ubuntu-{{ .arch }}' > docker.txt", "find ./dist -name '*docker*.tar.gz' -type f | xargs -n1 docker load -i"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "depends_on": ["update-package-json-version"]}, {"name": "publish-images-grafana", "image": "google/cloud-sdk:431.0.0", "environment": {"GCP_KEY": {"from_secret": "gcp_grafanauploads"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}, "GITHUB_APP_ID": {"from_secret": "delivery-bot-app-id"}, "GITHUB_APP_INSTALLATION_ID": {"from_secret": "delivery-bot-app-installation-id"}, "GITHUB_APP_PRIVATE_KEY": {"from_secret": "delivery-bot-app-private-key"}}, "commands": ["./bin/grabpl artifacts docker publish --dockerhub-repo grafana/grafana"], "depends_on": ["rgm-build-docker"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "when": {"repo": ["grafana/grafana"]}}, {"name": "publish-images-grafana-oss", "image": "google/cloud-sdk:431.0.0", "environment": {"GCP_KEY": {"from_secret": "gcp_grafanauploads"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}, "GITHUB_APP_ID": {"from_secret": "delivery-bot-app-id"}, "GITHUB_APP_INSTALLATION_ID": {"from_secret": "delivery-bot-app-installation-id"}, "GITHUB_APP_PRIVATE_KEY": {"from_secret": "delivery-bot-app-private-key"}}, "commands": ["./bin/grabpl artifacts docker publish --dockerhub-repo grafana/grafana-oss"], "depends_on": ["rgm-build-docker"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "when": {"repo": ["grafana/grafana"]}}, {"name": "release-canary-npm-packages", "image": "node:20.9.0-alpine", "depends_on": ["end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite", "build-frontend-packages"], "environment": {"NPM_TOKEN": {"from_secret": "npm_token"}}, "commands": ["apk add --update bash", "./scripts/publish-npm-packages.sh --dist-tag 'canary' --registry 'https://registry.npmjs.org'"], "when": {"repo": ["grafana/grafana"], "paths": {"include": ["packages/**"]}}}, {"name": "upload-packages", "image": "grafana/grafana-ci-deploy:1.3.3", "depends_on": ["end-to-end-tests-dashboards-suite", "end-to-end-tests-panels-suite", "end-to-end-tests-smoke-tests-suite", "end-to-end-tests-various-suite"], "environment": {"GCP_KEY": {"from_secret": "gcp_grafanauploads_base64"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/build upload-packages --edition oss"], "when": {"repo": ["grafana/grafana"]}}, {"name": "upload-cdn-assets", "image": "grafana/grafana-ci-deploy:1.3.3", "depends_on": ["grafana-server"], "environment": {"GCP_KEY": {"from_secret": "gcp_grafanauploads"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/build upload-cdn --edition oss"], "when": {"repo": ["grafana/grafana"]}}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "main-integration-tests", "trigger": {"event": ["push"], "branch": "main", "paths": {"exclude": ["*.md", "docs/**", "latest.json"]}, "repo": ["grafana/grafana"]}, "services": [{"name": "postgres", "image": "postgres:12.3-alpine", "environment": {"POSTGRES_USER": "grafanatest", "POSTGRES_PASSWORD": "grafanatest", "POSTGRES_DB": "grafanatest", "PGDATA": "/var/lib/postgresql/data/pgdata"}, "volumes": [{"name": "postgres", "path": "/var/lib/postgresql/data/pgdata"}]}, {"name": "mysql57", "image": "mysql:5.7.39", "environment": {"MYSQL_ROOT_PASSWORD": "rootpass", "MYSQL_DATABASE": "grafana_tests", "MYSQL_USER": "grafana", "MYSQL_PASSWORD": "password"}, "volumes": [{"name": "mysql57", "path": "/var/lib/mysql"}], "commands": ["docker-entrypoint.sh mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci"]}, {"name": "mysql80", "image": "mysql:8.0.32", "environment": {"MYSQL_ROOT_PASSWORD": "rootpass", "MYSQL_DATABASE": "grafana_tests", "MYSQL_USER": "grafana", "MYSQL_PASSWORD": "password"}, "volumes": [{"name": "mysql80", "path": "/var/lib/mysql"}], "commands": ["docker-entrypoint.sh mysqld --default-authentication-plugin=mysql_native_password"]}, {"name": "mimir_backend", "image": "us.gcr.io/kubernetes-dev/mimir:gotjosh-state-config-grafana-663a0ae78", "environment": {}, "commands": ["/bin/mimir -target=backend"]}, {"name": "redis", "image": "redis:6.2.11-alpine", "environment": {}}, {"name": "memcached", "image": "memcached:1.6.9-alpine", "environment": {}}], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v3.0.50/grabpl", "chmod +x bin/grabpl"]}, {"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "verify-gen-cue", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that code generated from Thema/CUE be committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-cue"]}, {"name": "verify-gen-jsonnet", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that generated jsonnet is committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-jsonnet"]}, {"name": "wire-install", "image": "golang:1.23.0-alpine", "commands": ["apk add --update make", "make gen-go"], "depends_on": ["verify-gen-cue"]}, {"name": "wait-for-postgres", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://postgres:5432 -timeout 120s"]}, {"name": "postgres-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-postgres"], "commands": ["apk add --update build-base", "apk add --update postgresql-client", "psql -p 5432 -h postgres -U grafanatest -d grafanatest -f devenv/docker/blocks/postgres_tests/setup.sql", "go clean -testcache", "go test -p=1 -count=1 -covermode=atomic -timeout=5m -run '^TestIntegration' $(find ./pkg -type f -name '*_test.go' -exec grep -l '^func TestIntegration' '{}' '+' | grep -o '\\(.*\\)/' | sort -u)"], "environment": {"PGPASSWORD": "grafanatest", "GRAFANA_TEST_DB": "postgres", "POSTGRES_HOST": "postgres"}}, {"name": "wait-for-mysql-5.7", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://mysql57:3306 -timeout 120s"]}, {"name": "mysql-5.7-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-mysql-5.7"], "commands": ["apk add --update build-base", "apk add --update mysql-client", "cat devenv/docker/blocks/mysql_tests/setup.sql | mysql -h mysql57 -P 3306 -u root -prootpass", "go clean -testcache", "go test -p=1 -count=1 -covermode=atomic -timeout=5m -run '^TestIntegration' $(find ./pkg -type f -name '*_test.go' -exec grep -l '^func TestIntegration' '{}' '+' | grep -o '\\(.*\\)/' | sort -u)"], "environment": {"GRAFANA_TEST_DB": "mysql", "MYSQL_HOST": "mysql57"}}, {"name": "wait-for-mysql-8.0", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://mysql80:3306 -timeout 120s"]}, {"name": "mysql-8.0-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-mysql-8.0"], "commands": ["apk add --update build-base", "apk add --update mysql-client", "cat devenv/docker/blocks/mysql_tests/setup.sql | mysql -h mysql80 -P 3306 -u root -prootpass", "go clean -testcache", "go test -p=1 -count=1 -covermode=atomic -timeout=5m -run '^TestIntegration' $(find ./pkg -type f -name '*_test.go' -exec grep -l '^func TestIntegration' '{}' '+' | grep -o '\\(.*\\)/' | sort -u)"], "environment": {"GRAFANA_TEST_DB": "mysql", "MYSQL_HOST": "mysql80"}}, {"name": "wait-for-redis", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://redis:6379 -timeout 120s"]}, {"name": "redis-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-redis"], "commands": ["apk add --update build-base", "go clean -testcache", "go list -f '{{.Dir}}/...' -m | xargs go test -run IntegrationRedis -covermode=atomic -timeout=2m"], "environment": {"REDIS_URL": "redis://redis:6379/0"}}, {"name": "wait-for-memcached", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://memcached:11211 -timeout 120s"]}, {"name": "memcached-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-memcached"], "commands": ["apk add --update build-base", "go clean -testcache", "go list -f '{{.Dir}}/...' -m | xargs go test -run IntegrationMemcached -covermode=atomic -timeout=2m"], "environment": {"MEMCACHED_HOSTS": "memcached:11211"}}, {"name": "wait-for-remote-alertmanager", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://mimir_backend:8080 -timeout 120s"]}, {"name": "remote-alertmanager-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-remote-alertmanager"], "commands": ["apk add --update build-base", "go clean -testcache", "go test -run TestIntegrationRemoteAlertmanager -covermode=atomic -timeout=2m ./pkg/services/ngalert/..."], "environment": {"AM_TENANT_ID": "test", "AM_URL": "http://mimir_backend:8080"}}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql57", "temp": {"medium": "memory"}}, {"name": "mysql80", "temp": {"medium": "memory"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "main-windows", "trigger": {"event": ["push"], "branch": "main", "paths": {"exclude": ["*.md", "docs/**", "latest.json"]}, "repo": ["grafana/grafana"]}, "services": [], "steps": [{"name": "identify-runner", "image": "mcr.microsoft.com/windows:1809", "commands": ["echo $env:DRONE_RUNNER_NAME"]}, {"name": "windows-init", "image": "grafana/ci-wix:0.1.1", "commands": ["$$ProgressPreference = \"SilentlyContinue\"", "Invoke-WebRequest https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v3.0.50/windows/grabpl.exe -OutFile grabpl.exe"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "//./pipe/docker_engine/"}}], "depends_on": ["main-test-frontend", "main-test-backend", "main-build-e2e-publish", "main-integration-tests"], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "windows", "arch": "amd64", "version": "1809"}}
---
{"kind": "pipeline", "type": "docker", "name": "main-trigger-downstream", "trigger": {"event": ["push"], "branch": "main", "paths": {"exclude": ["*.md", "docs/**", "latest.json"]}, "repo": ["grafana/grafana-security-mirror"]}, "services": [], "steps": [{"name": "trigger-enterprise-downstream", "image": "grafana/drone-downstream", "settings": {"server": "https://drone.grafana.net", "token": {"from_secret": "drone_token"}, "repositories": ["grafana/grafana-enterprise@main"], "params": ["SOURCE_BUILD_NUMBER=${DRONE_COMMIT}", "SOURCE_COMMIT=${DRONE_COMMIT}"]}}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["main-build-e2e-publish", "main-integration-tests"], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "platform": {"os": "linux", "arch": "amd64"}, "name": "main-notify", "trigger": {"event": ["push"], "branch": "main", "paths": {"exclude": ["*.md", "docs/**", "latest.json"]}, "repo": ["grafana/grafana"], "status": ["failure"]}, "steps": [{"name": "slack", "image": "plugins/slack", "settings": {"webhook": {"from_secret": "slack_webhook"}, "channel": "grafana-ci-notifications", "template": "Build {{build.number}} failed for commit: \u003chttps://github.com/{{repo.owner}}/{{repo.name}}/commit/{{build.commit}}|{{ truncate build.commit 8 }}\u003e: {{build.link}}\nBranch: \u003chttps://github.com/{{ repo.owner }}/{{ repo.name }}/commits/{{ build.branch }}|{{ build.branch }}\u003e\nAuthor: {{build.author}}"}}], "clone": {"retries": 3}, "depends_on": ["main-test-frontend", "main-test-backend", "main-build-e2e-publish", "main-integration-tests", "main-windows"]}
---
{"kind": "pipeline", "type": "docker", "name": "publish-docker-public", "trigger": {"event": ["promote"], "target": ["public"]}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v3.0.50/grabpl", "chmod +x bin/grabpl"]}, {"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "fetch-images", "image": "google/cloud-sdk:431.0.0", "environment": {"GCP_KEY": {"from_secret": "gcp_grafanauploads"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["./bin/build artifacts docker fetch --edition oss"], "depends_on": ["compile-build-cmd"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}, {"environment": {"DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "name": "publish-images-grafana", "image": "docker:27-cli", "depends_on": ["fetch-images"], "commands": ["apk add bash", "\n    bash -c '\n    debug=\n    if [[ -n $${DRY_RUN} ]];  then debug=echo; fi\n    docker login -u $${DOCKER_USER} -p $${DOCKER_PASSWORD}\n\n    # Push the grafana-image-tags images\n    $$debug docker push grafana/grafana-image-tags:$${TAG}-amd64\n    $$debug docker push grafana/grafana-image-tags:$${TAG}-arm64\n    $$debug docker push grafana/grafana-image-tags:$${TAG}-armv7\n    $$debug docker push grafana/grafana-image-tags:$${TAG}-ubuntu-amd64\n    $$debug docker push grafana/grafana-image-tags:$${TAG}-ubuntu-arm64\n    $$debug docker push grafana/grafana-image-tags:$${TAG}-ubuntu-armv7\n\n    # Create the grafana manifests\n    $$debug docker manifest create grafana/grafana:${TAG}       grafana/grafana-image-tags:$${TAG}-amd64       grafana/grafana-image-tags:$${TAG}-arm64       grafana/grafana-image-tags:$${TAG}-armv7\n\n    $$debug docker manifest create grafana/grafana:${TAG}-ubuntu       grafana/grafana-image-tags:$${TAG}-ubuntu-amd64       grafana/grafana-image-tags:$${TAG}-ubuntu-arm64       grafana/grafana-image-tags:$${TAG}-ubuntu-armv7\n\n    # Push the grafana manifests\n    $$debug docker manifest push grafana/grafana:$${TAG}\n    $$debug docker manifest push grafana/grafana:$${TAG}-ubuntu\n\n    # if LATEST is set, then also create \u0026 push latest\n    if [[ -n $${LATEST} ]]; then\n        $$debug docker manifest create grafana/grafana:latest           grafana/grafana-image-tags:$${TAG}-amd64           grafana/grafana-image-tags:$${TAG}-arm64           grafana/grafana-image-tags:$${TAG}-armv7\n        $$debug docker manifest create grafana/grafana:latest-ubuntu           grafana/grafana-image-tags:$${TAG}-ubuntu-amd64           grafana/grafana-image-tags:$${TAG}-ubuntu-arm64           grafana/grafana-image-tags:$${TAG}-ubuntu-armv7\n\n        $$debug docker manifest push grafana/grafana:latest\n        $$debug docker manifest push grafana/grafana:latest-ubuntu\n\n    fi'"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}, {"name": "publish-images-grafana-oss", "image": "google/cloud-sdk:431.0.0", "environment": {"GCP_KEY": {"from_secret": "gcp_grafanauploads"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}, "GITHUB_APP_ID": {"from_secret": "delivery-bot-app-id"}, "GITHUB_APP_INSTALLATION_ID": {"from_secret": "delivery-bot-app-installation-id"}, "GITHUB_APP_PRIVATE_KEY": {"from_secret": "delivery-bot-app-private-key"}}, "commands": ["./bin/grabpl artifacts docker publish --dockerhub-repo grafana/grafana-oss --version-tag ${DRONE_TAG}"], "depends_on": ["fetch-images"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "manually-publish-docker-public", "trigger": {"event": ["promote"], "target": ["publish-docker-public"]}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v3.0.50/grabpl", "chmod +x bin/grabpl"]}, {"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "fetch-images", "image": "google/cloud-sdk:431.0.0", "environment": {"GCP_KEY": {"from_secret": "gcp_grafanauploads"}, "DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["./bin/build artifacts docker fetch --edition oss"], "depends_on": ["compile-build-cmd"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}, {"environment": {"DOCKER_USER": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "name": "publish-images-grafana", "image": "docker:27-cli", "depends_on": ["fetch-images"], "commands": ["apk add bash", "\n    bash -c '\n    debug=\n    if [[ -n $${DRY_RUN} ]];  then debug=echo; fi\n    docker login -u $${DOCKER_USER} -p $${DOCKER_PASSWORD}\n\n    # Push the grafana-image-tags images\n    $$debug docker push grafana/grafana-image-tags:$${TAG}-amd64\n    $$debug docker push grafana/grafana-image-tags:$${TAG}-arm64\n    $$debug docker push grafana/grafana-image-tags:$${TAG}-armv7\n    $$debug docker push grafana/grafana-image-tags:$${TAG}-ubuntu-amd64\n    $$debug docker push grafana/grafana-image-tags:$${TAG}-ubuntu-arm64\n    $$debug docker push grafana/grafana-image-tags:$${TAG}-ubuntu-armv7\n\n    # Create the grafana manifests\n    $$debug docker manifest create grafana/grafana:${TAG}       grafana/grafana-image-tags:$${TAG}-amd64       grafana/grafana-image-tags:$${TAG}-arm64       grafana/grafana-image-tags:$${TAG}-armv7\n\n    $$debug docker manifest create grafana/grafana:${TAG}-ubuntu       grafana/grafana-image-tags:$${TAG}-ubuntu-amd64       grafana/grafana-image-tags:$${TAG}-ubuntu-arm64       grafana/grafana-image-tags:$${TAG}-ubuntu-armv7\n\n    # Push the grafana manifests\n    $$debug docker manifest push grafana/grafana:$${TAG}\n    $$debug docker manifest push grafana/grafana:$${TAG}-ubuntu\n\n    # if LATEST is set, then also create \u0026 push latest\n    if [[ -n $${LATEST} ]]; then\n        $$debug docker manifest create grafana/grafana:latest           grafana/grafana-image-tags:$${TAG}-amd64           grafana/grafana-image-tags:$${TAG}-arm64           grafana/grafana-image-tags:$${TAG}-armv7\n        $$debug docker manifest create grafana/grafana:latest-ubuntu           grafana/grafana-image-tags:$${TAG}-ubuntu-amd64           grafana/grafana-image-tags:$${TAG}-ubuntu-arm64           grafana/grafana-image-tags:$${TAG}-ubuntu-armv7\n\n        $$debug docker manifest push grafana/grafana:latest\n        $$debug docker manifest push grafana/grafana:latest-ubuntu\n\n    fi'"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "create-release-pr", "trigger": {"event": ["promote"], "target": "release-pr"}, "services": [], "steps": [{"name": "create-release-pr", "image": "byrnedo/alpine-curl:0.1.8", "depends_on": [], "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}, "GH_CLI_URL": "https://github.com/cli/cli/releases/download/v2.50.0/gh_2.50.0_linux_amd64.tar.gz"}, "commands": ["apk add perl", "v_target=`echo $${TAG} | perl -pe 's/^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$/v\\1.\\2.x/'`", "curl -L $${GH_CLI_URL} | tar -xz --strip-components=1 -C /usr", "gh workflow run -f dry_run=$${DRY_RUN} -f version=$${TAG} -f target=$${v_target} -f latest=$${LATEST} --repo=grafana/grafana release-pr.yml"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "publish-artifacts-public", "trigger": {"event": ["promote"], "target": ["public"]}, "services": [], "steps": [{"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "publish-artifacts", "image": "grafana/grafana-ci-deploy:1.3.3", "environment": {"GCP_KEY": {"from_secret": "gcp_grafanauploads_base64"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/build artifacts packages --tag $${DRONE_TAG} --src-bucket $${PRERELEASE_BUCKET}"], "depends_on": ["compile-build-cmd"]}, {"name": "publish-static-assets", "image": "grafana/grafana-ci-deploy:1.3.3", "environment": {"GCP_KEY": {"from_secret": "gcp_grafanauploads_base64"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}, "STATIC_ASSET_EDITIONS": {"from_secret": "static_asset_editions"}}, "commands": ["./bin/build artifacts static-assets --tag ${DRONE_TAG} --static-asset-editions=grafana-oss"], "depends_on": ["compile-build-cmd"]}, {"name": "publish-storybook", "image": "grafana/grafana-ci-deploy:1.3.3", "environment": {"GCP_KEY": {"from_secret": "gcp_grafanauploads_base64"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/build artifacts storybook --tag ${DRONE_TAG}"], "depends_on": ["compile-build-cmd"]}, {"name": "create-release-pr", "image": "byrnedo/alpine-curl:0.1.8", "depends_on": ["publish-artifacts", "publish-static-assets"], "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}, "GH_CLI_URL": "https://github.com/cli/cli/releases/download/v2.50.0/gh_2.50.0_linux_amd64.tar.gz"}, "commands": ["apk add perl", "v_target=`echo $${TAG} | perl -pe 's/^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)(?:-((?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*)(?:\\.(?:0|[1-9]\\d*|\\d*[a-zA-Z-][0-9a-zA-Z-]*))*))?(?:\\+([0-9a-zA-Z-]+(?:\\.[0-9a-zA-Z-]+)*))?$/v\\1.\\2.x/'`", "curl -L $${GH_CLI_URL} | tar -xz --strip-components=1 -C /usr", "gh workflow run -f dry_run=$${DRY_RUN} -f version=$${TAG} -f target=$${v_target} -f latest=$${LATEST} --repo=grafana/grafana release-pr.yml"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "publish-npm-packages-public", "trigger": {"event": ["promote"], "target": ["public"]}, "services": [], "steps": [{"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "yarn-install", "image": "node:20.9.0-alpine", "commands": ["yarn install --immutable"], "depends_on": []}, {"name": "retrieve-npm-packages", "image": "grafana/grafana-ci-deploy:1.3.3", "depends_on": ["compile-build-cmd", "yarn-install"], "failure": "ignore", "environment": {"GCP_KEY": {"from_secret": "gcp_grafanauploads_base64"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}}, "commands": ["./bin/build artifacts npm retrieve --tag ${DRONE_TAG}"]}, {"name": "release-npm-packages", "image": "node:20.9.0-alpine", "depends_on": ["compile-build-cmd", "retrieve-npm-packages"], "failure": "ignore", "environment": {"NPM_TOKEN": {"from_secret": "npm_token"}}, "commands": ["./bin/build artifacts npm release --tag ${DRONE_TAG}"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "verify-grafanacom-artifacts", "trigger": {"event": ["promote"], "target": "verify-grafanacom-artifacts"}, "services": [], "steps": [{"name": "verify-grafanacom", "image": "node:20.9.0-alpine", "commands": ["apk add curl bash", "\n            for i in {1..5}; do\n                if ./scripts/drone/verify-grafanacom.sh; then\n                    exit 0\n                elif [ $i -eq 5 ]; then\n                    exit 1\n                else\n                    sleep 60\n                fi\n            done\n            "], "depends_on": []}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "verify-linux-packages", "trigger": {"event": ["promote"], "target": "verify-linux-packages"}, "services": [], "steps": [{"name": "verify-linux-DEB-packages", "image": "ubuntu:22.04", "environment": {}, "commands": ["echo \"Step 1: Updating package lists...\"", "apt-get update >/dev/null 2>&1", "echo \"Step 2: Installing prerequisites...\"", "DEBIAN_FRONTEND=noninteractive apt-get install -yq apt-transport-https software-properties-common wget >/dev/null 2>&1", "echo \"Step 3: Adding Grafana GPG key...\"", "mkdir -p /etc/apt/keyrings/", "wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | tee /etc/apt/keyrings/grafana.gpg > /dev/null", "echo \"Step 4: Adding Grafana repository...\"", "echo \"deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main\" | tee -a /etc/apt/sources.list.d/grafana.list", "echo \"Step 5: Installing Grafana...\"", "for i in $(seq 1 10); do", "    if apt-get update >/dev/null 2>&1 && DEBIAN_FRONTEND=noninteractive apt-get install -yq grafana=${TAG} >/dev/null 2>&1; then", "        echo \"Command succeeded on attempt $i\"", "        break", "    else", "        echo \"Attempt $i failed\"", "        if [ $i -eq 10 ]; then", "            echo 'All attempts failed'", "            exit 1", "        fi", "        echo \"Waiting 60 seconds before next attempt...\"", "        sleep 60", "    fi", "done", "echo \"Step 6: Verifying Grafana installation...\"", "if dpkg -s grafana | grep -q \"Version: ${TAG}\"; then", "    echo \"Successfully verified Grafana version ${TAG}\"", "else", "    echo \"Failed to verify Grafana version ${TAG}\"", "    exit 1", "fi", "echo \"Verification complete.\""], "depends_on": []}, {"name": "verify-linux-RPM-packages", "image": "rockylinux:9", "environment": {}, "commands": ["echo \"Step 1: Updating package lists...\"", "dnf check-update -y >/dev/null 2>&1 || true", "echo \"Step 2: Installing prerequisites...\"", "dnf install -y dnf-utils >/dev/null 2>&1", "echo \"Step 3: Adding Grafana GPG key...\"", "rpm --import https://rpm.grafana.com/gpg.key", "echo \"Step 4: Configuring Grafana repository...\"", "echo -e '[grafana]\nname=grafana\nbaseurl=https://rpm.grafana.com\nrepo_gpgcheck=0\nenabled=1\ngpgcheck=0\ngpgkey=https://rpm.grafana.com/gpg.key\nsslverify=1\nsslcacert=/etc/pki/tls/certs/ca-bundle.crt\n' \u003e /etc/yum.repos.d/grafana.repo", "echo \"Step 5: Checking RPM repository...\"", "dnf list available grafana-${TAG}", "if [ $? -eq 0 ]; then", "    echo \"Grafana package found in repository. Installing from repo...\"", "for i in $(seq 1 5); do", "    if dnf install -y --nogpgcheck grafana-${TAG} >/dev/null 2>&1; then", "        echo \"Command succeeded on attempt $i\"", "        break", "    else", "        echo \"Attempt $i failed\"", "        if [ $i -eq 5 ]; then", "            echo 'All attempts failed'", "            exit 1", "        fi", "        echo \"Waiting 60 seconds before next attempt...\"", "        sleep 60", "    fi", "done", "    echo \"Verifying GPG key...\"", "    rpm --import https://rpm.grafana.com/gpg.key", "    rpm -qa gpg-pubkey* | xargs rpm -qi | grep -i grafana", "else", "    echo \"Grafana package version ${TAG} not found in repository.\"", "    dnf repolist", "    dnf list available grafana*", "    exit 1", "fi", "echo \"Step 6: Verifying Grafana installation...\"", "if rpm -q grafana | grep -q \"${TAG}\"; then", "    echo \"Successfully verified Grafana version ${TAG}\"", "else", "    echo \"Failed to verify Grafana version ${TAG}\"", "    exit 1", "fi", "echo \"Verification complete.\""], "depends_on": []}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "publish-packages", "trigger": {"event": ["promote"], "target": ["public"]}, "services": [], "steps": [{"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "publish-linux-packages-deb", "image": "us.gcr.io/kubernetes-dev/package-publish:latest", "depends_on": ["compile-build-cmd"], "privileged": true, "settings": {"access_key_id": {"from_secret": "packages_access_key_id"}, "secret_access_key": {"from_secret": "packages_secret_access_key"}, "service_account_json": {"from_secret": "packages_service_account"}, "target_bucket": "grafana-packages", "deb_distribution": "auto", "gpg_passphrase": {"from_secret": "packages_gpg_passphrase"}, "gpg_public_key": {"from_secret": "packages_gpg_public_key"}, "gpg_private_key": {"from_secret": "packages_gpg_private_key"}, "package_path": "gs://grafana-prerelease/artifacts/downloads/*${DRONE_TAG}/oss/**.deb"}}, {"name": "publish-linux-packages-rpm", "image": "us.gcr.io/kubernetes-dev/package-publish:latest", "depends_on": ["compile-build-cmd"], "privileged": true, "settings": {"access_key_id": {"from_secret": "packages_access_key_id"}, "secret_access_key": {"from_secret": "packages_secret_access_key"}, "service_account_json": {"from_secret": "packages_service_account"}, "target_bucket": "grafana-packages", "deb_distribution": "auto", "gpg_passphrase": {"from_secret": "packages_gpg_passphrase"}, "gpg_public_key": {"from_secret": "packages_gpg_public_key"}, "gpg_private_key": {"from_secret": "packages_gpg_private_key"}, "package_path": "gs://grafana-prerelease/artifacts/downloads/*${DRONE_TAG}/oss/**.rpm"}}, {"name": "verify-linux-DEB-packages", "image": "ubuntu:22.04", "environment": {}, "commands": ["echo \"Step 1: Updating package lists...\"", "apt-get update >/dev/null 2>&1", "echo \"Step 2: Installing prerequisites...\"", "DEBIAN_FRONTEND=noninteractive apt-get install -yq apt-transport-https software-properties-common wget >/dev/null 2>&1", "echo \"Step 3: Adding Grafana GPG key...\"", "mkdir -p /etc/apt/keyrings/", "wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | tee /etc/apt/keyrings/grafana.gpg > /dev/null", "echo \"Step 4: Adding Grafana repository...\"", "echo \"deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main\" | tee -a /etc/apt/sources.list.d/grafana.list", "echo \"Step 5: Installing Grafana...\"", "for i in $(seq 1 10); do", "    if apt-get update >/dev/null 2>&1 && DEBIAN_FRONTEND=noninteractive apt-get install -yq grafana=${TAG} >/dev/null 2>&1; then", "        echo \"Command succeeded on attempt $i\"", "        break", "    else", "        echo \"Attempt $i failed\"", "        if [ $i -eq 10 ]; then", "            echo 'All attempts failed'", "            exit 1", "        fi", "        echo \"Waiting 60 seconds before next attempt...\"", "        sleep 60", "    fi", "done", "echo \"Step 6: Verifying Grafana installation...\"", "if dpkg -s grafana | grep -q \"Version: ${TAG}\"; then", "    echo \"Successfully verified Grafana version ${TAG}\"", "else", "    echo \"Failed to verify Grafana version ${TAG}\"", "    exit 1", "fi", "echo \"Verification complete.\""], "depends_on": ["publish-linux-packages-deb"]}, {"name": "verify-linux-RPM-packages", "image": "rockylinux:9", "environment": {}, "commands": ["echo \"Step 1: Updating package lists...\"", "dnf check-update -y >/dev/null 2>&1 || true", "echo \"Step 2: Installing prerequisites...\"", "dnf install -y dnf-utils >/dev/null 2>&1", "echo \"Step 3: Adding Grafana GPG key...\"", "rpm --import https://rpm.grafana.com/gpg.key", "echo \"Step 4: Configuring Grafana repository...\"", "echo -e '[grafana]\nname=grafana\nbaseurl=https://rpm.grafana.com\nrepo_gpgcheck=0\nenabled=1\ngpgcheck=0\ngpgkey=https://rpm.grafana.com/gpg.key\nsslverify=1\nsslcacert=/etc/pki/tls/certs/ca-bundle.crt\n' \u003e /etc/yum.repos.d/grafana.repo", "echo \"Step 5: Checking RPM repository...\"", "dnf list available grafana-${TAG}", "if [ $? -eq 0 ]; then", "    echo \"Grafana package found in repository. Installing from repo...\"", "for i in $(seq 1 5); do", "    if dnf install -y --nogpgcheck grafana-${TAG} >/dev/null 2>&1; then", "        echo \"Command succeeded on attempt $i\"", "        break", "    else", "        echo \"Attempt $i failed\"", "        if [ $i -eq 5 ]; then", "            echo 'All attempts failed'", "            exit 1", "        fi", "        echo \"Waiting 60 seconds before next attempt...\"", "        sleep 60", "    fi", "done", "    echo \"Verifying GPG key...\"", "    rpm --import https://rpm.grafana.com/gpg.key", "    rpm -qa gpg-pubkey* | xargs rpm -qi | grep -i grafana", "else", "    echo \"Grafana package version ${TAG} not found in repository.\"", "    dnf repolist", "    dnf list available grafana*", "    exit 1", "fi", "echo \"Step 6: Verifying Grafana installation...\"", "if rpm -q grafana | grep -q \"${TAG}\"; then", "    echo \"Successfully verified Grafana version ${TAG}\"", "else", "    echo \"Failed to verify Grafana version ${TAG}\"", "    exit 1", "fi", "echo \"Verification complete.\""], "depends_on": ["publish-linux-packages-rpm"]}, {"name": "publish-grafanacom", "image": "grafana/grafana-ci-deploy:1.3.3", "depends_on": ["publish-linux-packages-deb", "publish-linux-packages-rpm"], "environment": {"GRAFANA_COM_API_KEY": {"from_secret": "grafana_api_key"}, "GCP_KEY": {"from_secret": "gcp_grafanauploads_base64"}}, "commands": ["./bin/build publish grafana-com --edition oss ${DRONE_TAG}"]}, {"name": "verify-grafanacom", "image": "node:20.9.0-alpine", "commands": ["apk add curl bash", "\n            for i in {1..5}; do\n                if ./scripts/drone/verify-grafanacom.sh; then\n                    exit 0\n                elif [ $i -eq 5 ]; then\n                    exit 1\n                else\n                    sleep 60\n                fi\n            done\n            "], "depends_on": ["publish-grafanacom"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["publish-artifacts-public", "publish-docker-public"], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "rgm-main-prerelease", "trigger": {"event": ["push"], "branch": "main", "paths": {"exclude": ["*.md", "docs/**", "packages/**/*.md", "latest.json"]}, "repo": ["grafana/grafana"]}, "services": [], "steps": [{"name": "rgm-build", "image": "grafana/grafana-build:main", "pull": "always", "commands": ["export GRAFANA_DIR=$$(pwd)", "cd /src && ./scripts/drone_build_main.sh"], "environment": {"GO_VERSION": "1.23.0", "ALPINE_BASE": "alpine:3.19.1", "UBUNTU_BASE": "ubuntu:22.04", "DESTINATION": {"from_secret": "destination"}, "STORYBOOK_DESTINATION": {"from_secret": "rgm_storybook_destination"}, "CDN_DESTINATION": {"from_secret": "rgm_cdn_destination"}, "DOWNLOADS_DESTINATION": {"from_secret": "rgm_downloads_destination"}, "GCP_KEY_BASE64": {"from_secret": "gcp_key_base64"}, "GITHUB_TOKEN": {"from_secret": "github_token"}, "_EXPERIMENTAL_DAGGER_CLOUD_TOKEN": {"from_secret": "dagger_token"}, "GPG_PRIVATE_KEY": {"from_secret": "packages_gpg_private_key"}, "GPG_PUBLIC_KEY": {"from_secret": "packages_gpg_public_key"}, "GPG_PASSPHRASE": {"from_secret": "packages_gpg_passphrase"}, "DOCKER_USERNAME": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}, "NPM_TOKEN": {"from_secret": "npm_token"}, "GCOM_API_KEY": {"from_secret": "grafana_api_key"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["main-test-backend", "main-test-frontend"], "image_pull_secrets": ["gcr", "gar"], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "release-whatsnew-checker", "trigger": {"event": {"exclude": ["promote"]}, "ref": {"include": ["refs/tags/v*"], "exclude": ["refs/tags/*-cloud*"]}}, "services": [], "steps": [{"name": "compile-build-cmd", "image": "golang:1.23.0-alpine", "commands": ["go build -o ./bin/build -ldflags '-extldflags -static' ./pkg/build/cmd"], "depends_on": [], "environment": {"CGO_ENABLED": 0}}, {"name": "whats-new-checker", "image": "golang:1.23.0-alpine", "depends_on": ["compile-build-cmd"], "commands": ["./bin/build whatsnew-checker"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "release-test-frontend", "trigger": {"event": {"exclude": ["promote"]}, "ref": {"include": ["refs/tags/v*"], "exclude": ["refs/tags/*-cloud*"]}}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "yarn-install", "image": "node:20.9.0-alpine", "commands": ["yarn install --immutable"], "depends_on": []}, {"name": "betterer-frontend", "image": "node:20.9.0-alpine", "depends_on": ["yarn-install"], "commands": ["apk add --update git bash", "yarn betterer ci"]}, {"name": "test-frontend", "image": "node:20.9.0-alpine", "environment": {"TEST_MAX_WORKERS": "50%"}, "depends_on": ["yarn-install"], "commands": ["yarn run ci:test-frontend"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "release-test-backend", "trigger": {"event": {"exclude": ["promote"]}, "ref": {"include": ["refs/tags/v*"], "exclude": ["refs/tags/*-cloud*"]}}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "verify-gen-cue", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that code generated from Thema/CUE be committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-cue"]}, {"name": "verify-gen-jsonnet", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that generated jsonnet is committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-jsonnet"]}, {"name": "wire-install", "image": "golang:1.23.0-alpine", "commands": ["apk add --update make", "make gen-go"], "depends_on": ["verify-gen-cue"]}, {"name": "test-backend", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install"], "commands": ["apk add --update build-base shared-mime-info shared-mime-info-lang", "go list -f '{{.Dir}}/...' -m | xargs go test -tags requires_buildifer -short -covermode=atomic -timeout=5m"]}, {"name": "test-backend-integration", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install"], "commands": ["apk add --update build-base", "go test -count=1 -covermode=atomic -timeout=5m -run '^TestIntegration' $(find ./pkg -type f -name '*_test.go' -exec grep -l '^func TestIntegration' '{}' '+' | grep -o '\\(.*\\)/' | sort -u)"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "rgm-tag-prerelease", "trigger": {"event": {"exclude": ["promote"]}, "ref": {"include": ["refs/tags/v*"], "exclude": ["refs/tags/*-cloud*"]}}, "services": [], "steps": [{"name": "rgm-build", "image": "grafana/grafana-build:main", "pull": "always", "commands": ["export GRAFANA_DIR=$$(pwd)", "cd /src && ./scripts/drone_build_tag_grafana.sh"], "environment": {"GO_VERSION": "1.23.0", "ALPINE_BASE": "alpine:3.19.1", "UBUNTU_BASE": "ubuntu:22.04", "DESTINATION": {"from_secret": "destination"}, "STORYBOOK_DESTINATION": {"from_secret": "rgm_storybook_destination"}, "CDN_DESTINATION": {"from_secret": "rgm_cdn_destination"}, "DOWNLOADS_DESTINATION": {"from_secret": "rgm_downloads_destination"}, "GCP_KEY_BASE64": {"from_secret": "gcp_key_base64"}, "GITHUB_TOKEN": {"from_secret": "github_token"}, "_EXPERIMENTAL_DAGGER_CLOUD_TOKEN": {"from_secret": "dagger_token"}, "GPG_PRIVATE_KEY": {"from_secret": "packages_gpg_private_key"}, "GPG_PUBLIC_KEY": {"from_secret": "packages_gpg_public_key"}, "GPG_PASSPHRASE": {"from_secret": "packages_gpg_passphrase"}, "DOCKER_USERNAME": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}, "NPM_TOKEN": {"from_secret": "npm_token"}, "GCOM_API_KEY": {"from_secret": "grafana_api_key"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["release-test-backend", "release-test-frontend"], "image_pull_secrets": ["gcr", "gar"], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "rgm-tag-prerelease-windows", "trigger": {"event": {"exclude": ["promote"]}, "ref": {"include": ["refs/tags/v*"], "exclude": ["refs/tags/*-cloud*"]}}, "services": [], "steps": [{"name": "identify-runner", "image": "mcr.microsoft.com/windows:1809", "commands": ["echo $env:DRONE_RUNNER_NAME"]}, {"name": "windows-init", "image": "grafana/ci-wix:0.1.1", "commands": ["$$ProgressPreference = \"SilentlyContinue\"", "Invoke-WebRequest https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v3.0.50/windows/grabpl.exe -OutFile grabpl.exe"]}, {"name": "build-windows-installer", "image": "grafana/ci-wix:0.1.1", "depends_on": ["windows-init"], "environment": {"GCP_KEY": {"from_secret": "gcp_grafanauploads_base64"}, "PRERELEASE_BUCKET": {"from_secret": "prerelease_bucket"}, "GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["$$gcpKey = $$env:GCP_KEY", "[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($$gcpKey)) > gcpkey.json", "dos2unix gcpkey.json", "gcloud auth activate-service-account --key-file=gcpkey.json", "rm gcpkey.json", "cp C:\\App\\nssm-2.24.zip .", ".\\grabpl.exe windows-installer --target gs://grafana-prerelease/artifacts/downloads/${DRONE_TAG}/oss/release/grafana-${DRONE_TAG:1}.windows-amd64.zip --edition oss ${DRONE_TAG}", "$$fname = ((Get-Childitem grafana*.msi -name) -split \"`n\")[0]", "gsutil cp $$fname gs://grafana-prerelease/artifacts/downloads/${DRONE_TAG}/oss/release/", "gsutil cp \"$$fname.sha256\" gs://grafana-prerelease/artifacts/downloads/${DRONE_TAG}/oss/release/"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "//./pipe/docker_engine/"}}], "depends_on": ["rgm-tag-prerelease"], "image_pull_secrets": ["gcr", "gar"], "platform": {"os": "windows", "arch": "amd64", "version": "1809"}}
---
{"kind": "pipeline", "type": "docker", "name": "rgm-tag-verify-prerelease-assets", "trigger": {"event": {"exclude": ["promote"]}, "ref": {"include": ["refs/tags/v*"], "exclude": ["refs/tags/*-cloud*"]}}, "services": [], "steps": [{"name": "gsutil-stat", "depends_on": ["clone"], "image": "google/cloud-sdk:431.0.0", "environment": {"BUCKET": "grafana-prerelease", "GCP_KEY": {"from_secret": "gcp_key_base64"}}, "commands": ["apt-get update && apt-get install -yq gettext", "printenv GCP_KEY | base64 -d > /tmp/key.json", "gcloud auth activate-service-account --key-file=/tmp/key.json", "./scripts/list-release-artifacts.sh ${DRONE_TAG} | xargs -n1 gsutil stat >> /tmp/stat.log", "! cat /tmp/stat.log | grep \"No URLs matched\""]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["rgm-tag-prerelease", "rgm-tag-prerelease-windows"], "image_pull_secrets": ["gcr", "gar"], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "rgm-version-branch-prerelease", "trigger": {"ref": ["refs/heads/v[0-9]*"]}, "services": [], "steps": [{"name": "rgm-build", "image": "grafana/grafana-build:main", "pull": "always", "commands": ["export GRAFANA_DIR=$$(pwd)", "cd /src && ./scripts/drone_build_tag_grafana.sh"], "environment": {"GO_VERSION": "1.23.0", "ALPINE_BASE": "alpine:3.19.1", "UBUNTU_BASE": "ubuntu:22.04", "DESTINATION": {"from_secret": "destination"}, "STORYBOOK_DESTINATION": {"from_secret": "rgm_storybook_destination"}, "CDN_DESTINATION": {"from_secret": "rgm_cdn_destination"}, "DOWNLOADS_DESTINATION": {"from_secret": "rgm_downloads_destination"}, "GCP_KEY_BASE64": {"from_secret": "gcp_key_base64"}, "GITHUB_TOKEN": {"from_secret": "github_token"}, "_EXPERIMENTAL_DAGGER_CLOUD_TOKEN": {"from_secret": "dagger_token"}, "GPG_PRIVATE_KEY": {"from_secret": "packages_gpg_private_key"}, "GPG_PUBLIC_KEY": {"from_secret": "packages_gpg_public_key"}, "GPG_PASSPHRASE": {"from_secret": "packages_gpg_passphrase"}, "DOCKER_USERNAME": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}, "NPM_TOKEN": {"from_secret": "npm_token"}, "GCOM_API_KEY": {"from_secret": "grafana_api_key"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["release-test-backend", "release-test-frontend"], "image_pull_secrets": ["gcr", "gar"], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "rgm-prerelease-verify-prerelease-assets", "trigger": {"ref": ["refs/heads/v[0-9]*"]}, "services": [], "steps": [{"name": "gsutil-stat", "depends_on": ["clone"], "image": "google/cloud-sdk:431.0.0", "environment": {"BUCKET": "grafana-prerelease", "GCP_KEY": {"from_secret": "gcp_key_base64"}}, "commands": ["apt-get update && apt-get install -yq gettext", "printenv GCP_KEY | base64 -d > /tmp/key.json", "gcloud auth activate-service-account --key-file=/tmp/key.json", "./scripts/list-release-artifacts.sh ${DRONE_TAG} | xargs -n1 gsutil stat >> /tmp/stat.log", "! cat /tmp/stat.log | grep \"No URLs matched\""]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["rgm-version-branch-prerelease"], "image_pull_secrets": ["gcr", "gar"], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "nightly-test-frontend", "trigger": {"event": {"include": ["cron"]}, "cron": {"include": ["nightly-release"]}}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "yarn-install", "image": "node:20.9.0-alpine", "commands": ["yarn install --immutable"], "depends_on": []}, {"name": "betterer-frontend", "image": "node:20.9.0-alpine", "depends_on": ["yarn-install"], "commands": ["apk add --update git bash", "yarn betterer ci"]}, {"name": "test-frontend", "image": "node:20.9.0-alpine", "environment": {"TEST_MAX_WORKERS": "50%"}, "depends_on": ["yarn-install"], "commands": ["yarn run ci:test-frontend"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "nightly-test-backend", "trigger": {"event": {"include": ["cron"]}, "cron": {"include": ["nightly-release"]}}, "services": [], "steps": [{"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "verify-gen-cue", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that code generated from Thema/CUE be committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-cue"]}, {"name": "verify-gen-jsonnet", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that generated jsonnet is committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-jsonnet"]}, {"name": "wire-install", "image": "golang:1.23.0-alpine", "commands": ["apk add --update make", "make gen-go"], "depends_on": ["verify-gen-cue"]}, {"name": "test-backend", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install"], "commands": ["apk add --update build-base shared-mime-info shared-mime-info-lang", "go list -f '{{.Dir}}/...' -m | xargs go test -tags requires_buildifer -short -covermode=atomic -timeout=5m"]}, {"name": "test-backend-integration", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install"], "commands": ["apk add --update build-base", "go test -count=1 -covermode=atomic -timeout=5m -run '^TestIntegration' $(find ./pkg -type f -name '*_test.go' -exec grep -l '^func TestIntegration' '{}' '+' | grep -o '\\(.*\\)/' | sort -u)"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "rgm-nightly-build", "trigger": {"event": {"include": ["cron"]}, "cron": {"include": ["nightly-release"]}}, "services": [], "steps": [{"name": "rgm-build", "image": "grafana/grafana-build:main", "pull": "always", "commands": ["export GRAFANA_DIR=$$(pwd)", "cd /src && ./scripts/drone_build_nightly_grafana.sh"], "environment": {"GO_VERSION": "1.23.0", "ALPINE_BASE": "alpine:3.19.1", "UBUNTU_BASE": "ubuntu:22.04", "DESTINATION": {"from_secret": "destination"}, "STORYBOOK_DESTINATION": {"from_secret": "rgm_storybook_destination"}, "CDN_DESTINATION": {"from_secret": "rgm_cdn_destination"}, "DOWNLOADS_DESTINATION": {"from_secret": "rgm_downloads_destination"}, "GCP_KEY_BASE64": {"from_secret": "gcp_key_base64"}, "GITHUB_TOKEN": {"from_secret": "github_token"}, "_EXPERIMENTAL_DAGGER_CLOUD_TOKEN": {"from_secret": "dagger_token"}, "GPG_PRIVATE_KEY": {"from_secret": "packages_gpg_private_key"}, "GPG_PUBLIC_KEY": {"from_secret": "packages_gpg_public_key"}, "GPG_PASSPHRASE": {"from_secret": "packages_gpg_passphrase"}, "DOCKER_USERNAME": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}, "NPM_TOKEN": {"from_secret": "npm_token"}, "GCOM_API_KEY": {"from_secret": "grafana_api_key"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}]}, {"name": "rgm-copy", "image": "google/cloud-sdk:alpine", "commands": ["mkdir -p $${DESTINATION}/$${DRONE_BUILD_EVENT}", "printenv GCP_KEY_BASE64 | base64 -d > /tmp/key.json", "gcloud auth activate-service-account --key-file=/tmp/key.json", "gcloud storage cp -r $${DRONE_WORKSPACE}/dist/* $${DESTINATION}/$${DRONE_BUILD_EVENT}"], "environment": {"DESTINATION": {"from_secret": "destination"}, "STORYBOOK_DESTINATION": {"from_secret": "rgm_storybook_destination"}, "CDN_DESTINATION": {"from_secret": "rgm_cdn_destination"}, "DOWNLOADS_DESTINATION": {"from_secret": "rgm_downloads_destination"}, "GCP_KEY_BASE64": {"from_secret": "gcp_key_base64"}, "GITHUB_TOKEN": {"from_secret": "github_token"}, "_EXPERIMENTAL_DAGGER_CLOUD_TOKEN": {"from_secret": "dagger_token"}, "GPG_PRIVATE_KEY": {"from_secret": "packages_gpg_private_key"}, "GPG_PUBLIC_KEY": {"from_secret": "packages_gpg_public_key"}, "GPG_PASSPHRASE": {"from_secret": "packages_gpg_passphrase"}, "DOCKER_USERNAME": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}, "NPM_TOKEN": {"from_secret": "npm_token"}, "GCOM_API_KEY": {"from_secret": "grafana_api_key"}}, "depends_on": ["rgm-build"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["nightly-test-backend", "nightly-test-frontend"], "image_pull_secrets": ["gcr", "gar"], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "rgm-nightly-publish", "trigger": {"event": {"include": ["cron"]}, "cron": {"include": ["nightly-release"]}}, "services": [], "steps": [{"name": "rgm-copy", "image": "google/cloud-sdk:alpine", "commands": ["mkdir -p $${DRONE_WORKSPACE}/dist", "printenv GCP_KEY_BASE64 | base64 -d > /tmp/key.json", "gcloud auth activate-service-account --key-file=/tmp/key.json", "gcloud storage cp -r $${DESTINATION}/$${DRONE_BUILD_EVENT}/*_$${DRONE_BUILD_NUMBER}_* $${DRONE_WORKSPACE}/dist"], "environment": {"DESTINATION": {"from_secret": "destination"}, "STORYBOOK_DESTINATION": {"from_secret": "rgm_storybook_destination"}, "CDN_DESTINATION": {"from_secret": "rgm_cdn_destination"}, "DOWNLOADS_DESTINATION": {"from_secret": "rgm_downloads_destination"}, "GCP_KEY_BASE64": {"from_secret": "gcp_key_base64"}, "GITHUB_TOKEN": {"from_secret": "github_token"}, "_EXPERIMENTAL_DAGGER_CLOUD_TOKEN": {"from_secret": "dagger_token"}, "GPG_PRIVATE_KEY": {"from_secret": "packages_gpg_private_key"}, "GPG_PUBLIC_KEY": {"from_secret": "packages_gpg_public_key"}, "GPG_PASSPHRASE": {"from_secret": "packages_gpg_passphrase"}, "DOCKER_USERNAME": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}, "NPM_TOKEN": {"from_secret": "npm_token"}, "GCOM_API_KEY": {"from_secret": "grafana_api_key"}}}, {"name": "rgm-publish", "image": "grafana/grafana-build:main", "pull": "always", "commands": ["export GRAFANA_DIR=$$(pwd)", "cd /src && ./scripts/drone_publish_nightly_grafana.sh"], "environment": {"GO_VERSION": "1.23.0", "ALPINE_BASE": "alpine:3.19.1", "UBUNTU_BASE": "ubuntu:22.04", "DESTINATION": {"from_secret": "destination"}, "STORYBOOK_DESTINATION": {"from_secret": "rgm_storybook_destination"}, "CDN_DESTINATION": {"from_secret": "rgm_cdn_destination"}, "DOWNLOADS_DESTINATION": {"from_secret": "rgm_downloads_destination"}, "GCP_KEY_BASE64": {"from_secret": "gcp_key_base64"}, "GITHUB_TOKEN": {"from_secret": "github_token"}, "_EXPERIMENTAL_DAGGER_CLOUD_TOKEN": {"from_secret": "dagger_token"}, "GPG_PRIVATE_KEY": {"from_secret": "packages_gpg_private_key"}, "GPG_PUBLIC_KEY": {"from_secret": "packages_gpg_public_key"}, "GPG_PASSPHRASE": {"from_secret": "packages_gpg_passphrase"}, "DOCKER_USERNAME": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}, "NPM_TOKEN": {"from_secret": "npm_token"}, "GCOM_API_KEY": {"from_secret": "grafana_api_key"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}], "depends_on": ["rgm-copy"]}, {"name": "publish-deb", "image": "us.gcr.io/kubernetes-dev/package-publish:latest", "privileged": true, "settings": {"access_key_id": {"from_secret": "packages_access_key_id"}, "secret_access_key": {"from_secret": "packages_secret_access_key"}, "service_account_json": {"from_secret": "packages_service_account"}, "target_bucket": "grafana-packages", "gpg_passphrase": {"from_secret": "packages_gpg_passphrase"}, "gpg_public_key": {"from_secret": "packages_gpg_public_key"}, "gpg_private_key": {"from_secret": "packages_gpg_private_key"}, "package_path": "file:///drone/src/dist/*.deb"}, "depends_on": ["rgm-publish"]}, {"name": "publish-rpm", "image": "us.gcr.io/kubernetes-dev/package-publish:latest", "privileged": true, "settings": {"access_key_id": {"from_secret": "packages_access_key_id"}, "secret_access_key": {"from_secret": "packages_secret_access_key"}, "service_account_json": {"from_secret": "packages_service_account"}, "target_bucket": "grafana-packages", "gpg_passphrase": {"from_secret": "packages_gpg_passphrase"}, "gpg_public_key": {"from_secret": "packages_gpg_public_key"}, "gpg_private_key": {"from_secret": "packages_gpg_private_key"}, "package_path": "file:///drone/src/dist/*.rpm"}, "depends_on": ["rgm-publish"]}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}], "depends_on": ["rgm-nightly-build"], "image_pull_secrets": ["gcr", "gar"], "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "testing-test-backend-windows", "trigger": {"event": ["promote"], "target": ["test-windows"]}, "services": [], "steps": [{"name": "clone", "image": "grafana/ci-wix:0.1.1", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["git clone \"https://$$env:GITHUB_TOKEN@github.com/$$env:DRONE_REPO.git\" .", "git checkout -f $$env:DRONE_COMMIT"]}, {"name": "windows-init", "image": "golang:1.23.0-windowsservercore-1809", "depends_on": ["clone"], "commands": []}, {"name": "wire-install", "image": "golang:1.23.0-windowsservercore-1809", "commands": ["go install github.com/google/wire/cmd/wire@v0.5.0", "wire gen -tags oss ./pkg/server"], "depends_on": ["windows-init"]}, {"name": "test-backend", "image": "golang:1.23.0-windowsservercore-1809", "depends_on": ["wire-install"], "commands": ["go test -tags requires_buildifer -short -covermode=atomic -timeout=5m ./pkg/..."]}], "clone": {"disable": true}, "volumes": [{"name": "docker", "host": {"path": "//./pipe/docker_engine/"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "windows", "arch": "amd64", "version": "1809"}}
---
{"kind": "pipeline", "type": "docker", "name": "integration-tests", "trigger": {"event": ["promote"], "target": "integration-tests"}, "services": [{"name": "postgres", "image": "postgres:12.3-alpine", "environment": {"POSTGRES_USER": "grafanatest", "POSTGRES_PASSWORD": "grafanatest", "POSTGRES_DB": "grafanatest", "PGDATA": "/var/lib/postgresql/data/pgdata"}, "volumes": [{"name": "postgres", "path": "/var/lib/postgresql/data/pgdata"}]}, {"name": "mysql57", "image": "mysql:5.7.39", "environment": {"MYSQL_ROOT_PASSWORD": "rootpass", "MYSQL_DATABASE": "grafana_tests", "MYSQL_USER": "grafana", "MYSQL_PASSWORD": "password"}, "volumes": [{"name": "mysql57", "path": "/var/lib/mysql"}], "commands": ["docker-entrypoint.sh mysqld --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci"]}, {"name": "mysql80", "image": "mysql:8.0.32", "environment": {"MYSQL_ROOT_PASSWORD": "rootpass", "MYSQL_DATABASE": "grafana_tests", "MYSQL_USER": "grafana", "MYSQL_PASSWORD": "password"}, "volumes": [{"name": "mysql80", "path": "/var/lib/mysql"}], "commands": ["docker-entrypoint.sh mysqld --default-authentication-plugin=mysql_native_password"]}, {"name": "mimir_backend", "image": "us.gcr.io/kubernetes-dev/mimir:gotjosh-state-config-grafana-663a0ae78", "environment": {}, "commands": ["/bin/mimir -target=backend"]}, {"name": "redis", "image": "redis:6.2.11-alpine", "environment": {}}, {"name": "memcached", "image": "memcached:1.6.9-alpine", "environment": {}}], "steps": [{"name": "grabpl", "image": "byrnedo/alpine-curl:0.1.8", "commands": ["mkdir -p bin", "curl -fL -o bin/grabpl https://grafana-downloads.storage.googleapis.com/grafana-build-pipeline/v3.0.50/grabpl", "chmod +x bin/grabpl"]}, {"name": "identify-runner", "image": "alpine:3.19.1", "commands": ["echo $DRONE_RUNNER_NAME"]}, {"name": "verify-gen-cue", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that code generated from Thema/CUE be committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-cue"]}, {"name": "verify-gen-jsonnet", "image": "golang:1.23.0-alpine", "depends_on": [], "commands": ["# It is required that generated jsonnet is committed and in sync with its inputs.", "# The following command will fail if running code generators produces any diff in output.", "apk add --update make", "CODEGEN_VERIFY=1 make gen-jsonnet"]}, {"name": "wire-install", "image": "golang:1.23.0-alpine", "commands": ["apk add --update make", "make gen-go"], "depends_on": ["verify-gen-cue"]}, {"name": "wait-for-postgres", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://postgres:5432 -timeout 120s"]}, {"name": "postgres-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-postgres"], "commands": ["apk add --update build-base", "apk add --update postgresql-client", "psql -p 5432 -h postgres -U grafanatest -d grafanatest -f devenv/docker/blocks/postgres_tests/setup.sql", "go clean -testcache", "go test -p=1 -count=1 -covermode=atomic -timeout=5m -run '^TestIntegration' $(find ./pkg -type f -name '*_test.go' -exec grep -l '^func TestIntegration' '{}' '+' | grep -o '\\(.*\\)/' | sort -u)"], "environment": {"PGPASSWORD": "grafanatest", "GRAFANA_TEST_DB": "postgres", "POSTGRES_HOST": "postgres"}}, {"name": "wait-for-mysql-5.7", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://mysql57:3306 -timeout 120s"]}, {"name": "mysql-5.7-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-mysql-5.7"], "commands": ["apk add --update build-base", "apk add --update mysql-client", "cat devenv/docker/blocks/mysql_tests/setup.sql | mysql -h mysql57 -P 3306 -u root -prootpass", "go clean -testcache", "go test -p=1 -count=1 -covermode=atomic -timeout=5m -run '^TestIntegration' $(find ./pkg -type f -name '*_test.go' -exec grep -l '^func TestIntegration' '{}' '+' | grep -o '\\(.*\\)/' | sort -u)"], "environment": {"GRAFANA_TEST_DB": "mysql", "MYSQL_HOST": "mysql57"}}, {"name": "wait-for-mysql-8.0", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://mysql80:3306 -timeout 120s"]}, {"name": "mysql-8.0-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-mysql-8.0"], "commands": ["apk add --update build-base", "apk add --update mysql-client", "cat devenv/docker/blocks/mysql_tests/setup.sql | mysql -h mysql80 -P 3306 -u root -prootpass", "go clean -testcache", "go test -p=1 -count=1 -covermode=atomic -timeout=5m -run '^TestIntegration' $(find ./pkg -type f -name '*_test.go' -exec grep -l '^func TestIntegration' '{}' '+' | grep -o '\\(.*\\)/' | sort -u)"], "environment": {"GRAFANA_TEST_DB": "mysql", "MYSQL_HOST": "mysql80"}}, {"name": "wait-for-redis", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://redis:6379 -timeout 120s"]}, {"name": "redis-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-redis"], "commands": ["apk add --update build-base", "go clean -testcache", "go list -f '{{.Dir}}/...' -m | xargs go test -run IntegrationRedis -covermode=atomic -timeout=2m"], "environment": {"REDIS_URL": "redis://redis:6379/0"}}, {"name": "wait-for-memcached", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://memcached:11211 -timeout 120s"]}, {"name": "memcached-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-memcached"], "commands": ["apk add --update build-base", "go clean -testcache", "go list -f '{{.Dir}}/...' -m | xargs go test -run IntegrationMemcached -covermode=atomic -timeout=2m"], "environment": {"MEMCACHED_HOSTS": "memcached:11211"}}, {"name": "wait-for-remote-alertmanager", "image": "jwilder/dockerize:0.6.1", "commands": ["dockerize -wait tcp://mimir_backend:8080 -timeout 120s"]}, {"name": "remote-alertmanager-integration-tests", "image": "golang:1.23.0-alpine", "depends_on": ["wire-install", "wait-for-remote-alertmanager"], "commands": ["apk add --update build-base", "go clean -testcache", "go test -run TestIntegrationRemoteAlertmanager -covermode=atomic -timeout=2m ./pkg/services/ngalert/..."], "environment": {"AM_TENANT_ID": "test", "AM_URL": "http://mimir_backend:8080"}}], "clone": {"retries": 3}, "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "postgres", "temp": {"medium": "memory"}}, {"name": "mysql57", "temp": {"medium": "memory"}}, {"name": "mysql80", "temp": {"medium": "memory"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "environment": {"EDITION": "oss"}, "platform": {"os": "linux", "arch": "amd64"}, "node": {"type": "no-parallel"}}
---
{"kind": "pipeline", "type": "docker", "name": "publish-ci-windows-test-image", "trigger": {"event": ["promote"], "target": ["ci-windows-test-image"]}, "services": [], "steps": [{"name": "clone", "image": "grafana/ci-wix:0.1.1", "environment": {"GITHUB_TOKEN": {"from_secret": "github_token"}}, "commands": ["git clone \"https://$$env:GITHUB_TOKEN@github.com/grafana/grafana-ci-sandbox.git\" .", "git checkout -f $$env:DRONE_COMMIT"]}, {"name": "build-and-publish", "image": "docker:windowsservercore-1809", "environment": {"DOCKER_USERNAME": {"from_secret": "docker_username"}, "DOCKER_PASSWORD": {"from_secret": "docker_password"}}, "commands": ["cd scripts\\build\\ci-windows-test", "docker login -u $$env:DOCKER_USERNAME -p $$env:DOCKER_PASSWORD", "docker build -t grafana/grafana-ci-windows-test:$$env:TAG .", "docker push grafana/grafana-ci-windows-test:$$env:TAG"], "volumes": [{"name": "docker", "path": "//./pipe/docker_engine/"}]}], "clone": {"disable": true}, "volumes": [{"name": "docker", "host": {"path": "//./pipe/docker_engine/"}}], "depends_on": [], "image_pull_secrets": ["gcr", "gar"], "platform": {"os": "windows", "arch": "amd64", "version": "1809"}}
---
{"kind": "pipeline", "type": "docker", "platform": {"os": "linux", "arch": "amd64"}, "name": "scan-grafana/grafana:latest-image", "trigger": {"event": "cron", "cron": "nightly"}, "clone": {"retries": 3}, "steps": [{"name": "authenticate-gcr", "image": "docker:dind", "commands": ["echo $${GCR_CREDENTIALS} | docker login -u _json_key --password-stdin https://us.gcr.io"], "environment": {"GCR_CREDENTIALS": {"from_secret": "gcr_credentials"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "scan-unknown-low-medium-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy image --exit-code 0 --severity UNKNOWN,LOW,MEDIUM grafana/grafana:latest"], "depends_on": ["authenticate-gcr"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "scan-high-critical-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy image --exit-code 1 --severity HIGH,CRITICAL grafana/grafana:latest"], "depends_on": ["authenticate-gcr"], "environment": {"GOOGLE_APPLICATION_CREDENTIALS": {"from_secret": "gcr_credentials_json"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "slack-notify-failure", "image": "plugins/slack", "settings": {"webhook": {"from_secret": "slack_webhook_backend"}, "channel": "grafana-backend-ops", "template": "Nightly docker image scan job for grafana/grafana:latest failed: {{build.link}}"}, "when": {"status": "failure"}}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "config", "temp": {}}]}
---
{"kind": "pipeline", "type": "docker", "platform": {"os": "linux", "arch": "amd64"}, "name": "scan-grafana/grafana:main-image", "trigger": {"event": "cron", "cron": "nightly"}, "clone": {"retries": 3}, "steps": [{"name": "authenticate-gcr", "image": "docker:dind", "commands": ["echo $${GCR_CREDENTIALS} | docker login -u _json_key --password-stdin https://us.gcr.io"], "environment": {"GCR_CREDENTIALS": {"from_secret": "gcr_credentials"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "scan-unknown-low-medium-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy image --exit-code 0 --severity UNKNOWN,LOW,MEDIUM grafana/grafana:main"], "depends_on": ["authenticate-gcr"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "scan-high-critical-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy image --exit-code 1 --severity HIGH,CRITICAL grafana/grafana:main"], "depends_on": ["authenticate-gcr"], "environment": {"GOOGLE_APPLICATION_CREDENTIALS": {"from_secret": "gcr_credentials_json"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "slack-notify-failure", "image": "plugins/slack", "settings": {"webhook": {"from_secret": "slack_webhook_backend"}, "channel": "grafana-backend-ops", "template": "Nightly docker image scan job for grafana/grafana:main failed: {{build.link}}"}, "when": {"status": "failure"}}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "config", "temp": {}}]}
---
{"kind": "pipeline", "type": "docker", "platform": {"os": "linux", "arch": "amd64"}, "name": "scan-grafana/grafana:latest-ubuntu-image", "trigger": {"event": "cron", "cron": "nightly"}, "clone": {"retries": 3}, "steps": [{"name": "authenticate-gcr", "image": "docker:dind", "commands": ["echo $${GCR_CREDENTIALS} | docker login -u _json_key --password-stdin https://us.gcr.io"], "environment": {"GCR_CREDENTIALS": {"from_secret": "gcr_credentials"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "scan-unknown-low-medium-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy image --exit-code 0 --severity UNKNOWN,LOW,MEDIUM grafana/grafana:latest-ubuntu"], "depends_on": ["authenticate-gcr"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "scan-high-critical-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy image --exit-code 1 --severity HIGH,CRITICAL grafana/grafana:latest-ubuntu"], "depends_on": ["authenticate-gcr"], "environment": {"GOOGLE_APPLICATION_CREDENTIALS": {"from_secret": "gcr_credentials_json"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "slack-notify-failure", "image": "plugins/slack", "settings": {"webhook": {"from_secret": "slack_webhook_backend"}, "channel": "grafana-backend-ops", "template": "Nightly docker image scan job for grafana/grafana:latest-ubuntu failed: {{build.link}}"}, "when": {"status": "failure"}}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "config", "temp": {}}]}
---
{"kind": "pipeline", "type": "docker", "platform": {"os": "linux", "arch": "amd64"}, "name": "scan-grafana/grafana:main-ubuntu-image", "trigger": {"event": "cron", "cron": "nightly"}, "clone": {"retries": 3}, "steps": [{"name": "authenticate-gcr", "image": "docker:dind", "commands": ["echo $${GCR_CREDENTIALS} | docker login -u _json_key --password-stdin https://us.gcr.io"], "environment": {"GCR_CREDENTIALS": {"from_secret": "gcr_credentials"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "scan-unknown-low-medium-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy image --exit-code 0 --severity UNKNOWN,LOW,MEDIUM grafana/grafana:main-ubuntu"], "depends_on": ["authenticate-gcr"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "scan-high-critical-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy image --exit-code 1 --severity HIGH,CRITICAL grafana/grafana:main-ubuntu"], "depends_on": ["authenticate-gcr"], "environment": {"GOOGLE_APPLICATION_CREDENTIALS": {"from_secret": "gcr_credentials_json"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "slack-notify-failure", "image": "plugins/slack", "settings": {"webhook": {"from_secret": "slack_webhook_backend"}, "channel": "grafana-backend-ops", "template": "Nightly docker image scan job for grafana/grafana:main-ubuntu failed: {{build.link}}"}, "when": {"status": "failure"}}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "config", "temp": {}}]}
---
{"kind": "pipeline", "type": "docker", "platform": {"os": "linux", "arch": "amd64"}, "name": "scan-build-test-and-publish-docker-images", "trigger": {"event": "cron", "cron": "nightly"}, "clone": {"retries": 3}, "steps": [{"name": "authenticate-gcr", "image": "docker:dind", "commands": ["echo $${GCR_CREDENTIALS} | docker login -u _json_key --password-stdin https://us.gcr.io"], "environment": {"GCR_CREDENTIALS": {"from_secret": "gcr_credentials"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "scan-unknown-low-medium-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM docker:27-cli", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM alpine/git:2.40.1", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM golang:1.23.0-alpine", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM node:20.9.0-alpine", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM google/cloud-sdk:431.0.0", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM grafana/grafana-ci-deploy:1.3.3", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM alpine:3.19.1", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM ubuntu:22.04", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM byrnedo/alpine-curl:0.1.8", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM plugins/slack", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM python:3.8", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM postgres:12.3-alpine", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM us.gcr.io/kubernetes-dev/mimir:gotjosh-state-config-grafana-663a0ae78", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM mysql:5.7.39", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM mysql:8.0.32", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM redis:6.2.11-alpine", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM memcached:1.6.9-alpine", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM us.gcr.io/kubernetes-dev/package-publish:latest", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM osixia/openldap:1.4.0", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM grafana/drone-downstream", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM grafana/docker-puppeteer:1.1.0", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM grafana/docs-base:latest", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM cypress/included:13.1.0", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM jwilder/dockerize:0.6.1", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM koalaman/shellcheck:stable", "trivy --exit-code 0 --severity UNKNOWN,LOW,MEDIUM rockylinux:9"], "depends_on": ["authenticate-gcr"], "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "scan-high-critical-vulnerabilities", "image": "aquasec/trivy:0.21.0", "commands": ["trivy --exit-code 1 --severity HIGH,CRITICAL docker:27-cli", "trivy --exit-code 1 --severity HIGH,CRITICAL alpine/git:2.40.1", "trivy --exit-code 1 --severity HIGH,CRITICAL golang:1.23.0-alpine", "trivy --exit-code 1 --severity HIGH,CRITICAL node:20.9.0-alpine", "trivy --exit-code 1 --severity HIGH,CRITICAL google/cloud-sdk:431.0.0", "trivy --exit-code 1 --severity HIGH,CRITICAL grafana/grafana-ci-deploy:1.3.3", "trivy --exit-code 1 --severity HIGH,CRITICAL alpine:3.19.1", "trivy --exit-code 1 --severity HIGH,CRITICAL ubuntu:22.04", "trivy --exit-code 1 --severity HIGH,CRITICAL byrnedo/alpine-curl:0.1.8", "trivy --exit-code 1 --severity HIGH,CRITICAL plugins/slack", "trivy --exit-code 1 --severity HIGH,CRITICAL python:3.8", "trivy --exit-code 1 --severity HIGH,CRITICAL postgres:12.3-alpine", "trivy --exit-code 1 --severity HIGH,CRITICAL us.gcr.io/kubernetes-dev/mimir:gotjosh-state-config-grafana-663a0ae78", "trivy --exit-code 1 --severity HIGH,CRITICAL mysql:5.7.39", "trivy --exit-code 1 --severity HIGH,CRITICAL mysql:8.0.32", "trivy --exit-code 1 --severity HIGH,CRITICAL redis:6.2.11-alpine", "trivy --exit-code 1 --severity HIGH,CRITICAL memcached:1.6.9-alpine", "trivy --exit-code 1 --severity HIGH,CRITICAL us.gcr.io/kubernetes-dev/package-publish:latest", "trivy --exit-code 1 --severity HIGH,CRITICAL osixia/openldap:1.4.0", "trivy --exit-code 1 --severity HIGH,CRITICAL grafana/drone-downstream", "trivy --exit-code 1 --severity HIGH,CRITICAL grafana/docker-puppeteer:1.1.0", "trivy --exit-code 1 --severity HIGH,CRITICAL grafana/docs-base:latest", "trivy --exit-code 1 --severity HIGH,CRITICAL cypress/included:13.1.0", "trivy --exit-code 1 --severity HIGH,CRITICAL jwilder/dockerize:0.6.1", "trivy --exit-code 1 --severity HIGH,CRITICAL koalaman/shellcheck:stable", "trivy --exit-code 1 --severity HIGH,CRITICAL rockylinux:9"], "depends_on": ["authenticate-gcr"], "environment": {"GOOGLE_APPLICATION_CREDENTIALS": {"from_secret": "gcr_credentials_json"}}, "volumes": [{"name": "docker", "path": "/var/run/docker.sock"}, {"name": "config", "path": "/root/.docker/"}]}, {"name": "slack-notify-failure", "image": "plugins/slack", "settings": {"webhook": {"from_secret": "slack_webhook_backend"}, "channel": "grafana-backend-ops", "template": "Nightly docker image scan job for build-images failed: {{build.link}}"}, "when": {"status": "failure"}}], "volumes": [{"name": "docker", "host": {"path": "/var/run/docker.sock"}}, {"name": "config", "temp": {}}]}
---
{"kind": "secret", "name": "gcp_grafanauploads", "get": {"path": "infra/data/ci/grafana-release-eng/grafanauploads", "name": "credentials.json"}}
---
{"kind": "secret", "name": "gcp_grafanauploads_base64", "get": {"path": "infra/data/ci/grafana-release-eng/grafanauploads", "name": "credentials_base64"}}
---
{"kind": "secret", "name": "grafana_api_key", "get": {"path": "infra/data/ci/grafana-release-eng/grafanacom", "name": "api_key"}}
---
{"kind": "secret", "name": "gcr", "get": {"path": "secret/data/common/gcr", "name": ".dockerconfigjson"}}
---
{"kind": "secret", "name": "gar", "get": {"path": "secret/data/common/gar", "name": ".dockerconfigjson"}}
---
{"kind": "secret", "name": "github_token", "get": {"path": "infra/data/ci/github/grafanabot", "name": "pat"}}
---
{"kind": "secret", "name": "drone_token", "get": {"path": "infra/data/ci/drone", "name": "machine-user-token"}}
---
{"kind": "secret", "name": "prerelease_bucket", "get": {"path": "infra/data/ci/grafana/prerelease", "name": "bucket"}}
---
{"kind": "secret", "name": "docker_username", "get": {"path": "infra/data/ci/grafanaci-docker-hub", "name": "username"}}
---
{"kind": "secret", "name": "docker_password", "get": {"path": "infra/data/ci/grafanaci-docker-hub", "name": "password"}}
---
{"kind": "secret", "name": "gcp_upload_artifacts_key", "get": {"path": "infra/data/ci/grafana/releng/artifacts-uploader-service-account", "name": "credentials.json"}}
---
{"kind": "secret", "name": "gcp_download_build_container_assets_key", "get": {"path": "infra/data/ci/grafana/assets-downloader-build-container-service-account", "name": "credentials.json"}}
---
{"kind": "secret", "name": "azure_sp_app_id", "get": {"path": "infra/data/ci/datasources/cpp-azure-resourcemanager-credentials", "name": "application_id"}}
---
{"kind": "secret", "name": "azure_sp_app_pw", "get": {"path": "infra/data/ci/datasources/cpp-azure-resourcemanager-credentials", "name": "application_secret"}}
---
{"kind": "secret", "name": "azure_tenant", "get": {"path": "infra/data/ci/datasources/cpp-azure-resourcemanager-credentials", "name": "tenant_id"}}
---
{"kind": "secret", "name": "npm_token", "get": {"path": "infra/data/ci/grafana-release-eng/npm", "name": "token"}}
---
{"kind": "secret", "name": "packages_gpg_public_key", "get": {"path": "infra/data/ci/packages-publish/gpg", "name": "public-key-b64"}}
---
{"kind": "secret", "name": "packages_gpg_private_key", "get": {"path": "infra/data/ci/packages-publish/gpg", "name": "private-key-b64"}}
---
{"kind": "secret", "name": "packages_gpg_passphrase", "get": {"path": "infra/data/ci/packages-publish/gpg", "name": "passphrase"}}
---
{"kind": "secret", "name": "packages_service_account", "get": {"path": "infra/data/ci/packages-publish/service-account", "name": "credentials.json"}}
---
{"kind": "secret", "name": "packages_access_key_id", "get": {"path": "infra/data/ci/packages-publish/bucket-credentials", "name": "AccessID"}}
---
{"kind": "secret", "name": "packages_secret_access_key", "get": {"path": "infra/data/ci/packages-publish/bucket-credentials", "name": "Secret"}}
---
{"kind": "secret", "name": "static_asset_editions", "get": {"path": "infra/data/ci/grafana-release-eng/artifact-publishing", "name": "static_asset_editions"}}
---
{"kind": "secret", "name": "gcp_key_base64", "get": {"path": "infra/data/ci/grafana-release-eng/rgm", "name": "gcp_service_account_prod_base64"}}
---
{"kind": "secret", "name": "destination", "get": {"path": "infra/data/ci/grafana-release-eng/rgm", "name": "destination_prod"}}
---
{"kind": "secret", "name": "rgm_storybook_destination", "get": {"path": "infra/data/ci/grafana-release-eng/rgm", "name": "storybook_destination"}}
---
{"kind": "secret", "name": "rgm_cdn_destination", "get": {"path": "infra/data/ci/grafana-release-eng/rgm", "name": "cdn_destination"}}
---
{"kind": "secret", "name": "rgm_downloads_destination", "get": {"path": "infra/data/ci/grafana-release-eng/rgm", "name": "downloads_destination"}}
---
{"kind": "secret", "name": "dagger_token", "get": {"path": "infra/data/ci/grafana-release-eng/rgm", "name": "dagger_token"}}
---
{"kind": "secret", "name": "delivery-bot-app-id", "get": {"path": "infra/data/ci/grafana-release-eng/grafana-delivery-bot", "name": "app-id"}}
---
{"kind": "secret", "name": "delivery-bot-app-installation-id", "get": {"path": "infra/data/ci/grafana-release-eng/grafana-delivery-bot", "name": "app-installation-id"}}
---
{"kind": "secret", "name": "delivery-bot-app-private-key", "get": {"path": "infra/data/ci/grafana-release-eng/grafana-delivery-bot", "name": "app-private-key"}}
---
{"kind": "secret", "name": "gcr_credentials", "get": {"path": "secret/data/common/gcr", "name": "service-account"}}
